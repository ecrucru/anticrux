/*
	AntiCrux - Artificial intelligence playing AntiChess and AntiChess960 with jQuery Mobile and Node.js
	Copyright (C) 2016-2017, ecrucru

		https://github.com/ecrucru/anticrux/
		http://ecrucru.free.fr/?page=anticrux

	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU Affero General Public License as
	published by the Free Software Foundation, either version 3 of the
	License, or (at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
	GNU Affero General Public License for more details.

	You should have received a copy of the GNU Affero General Public License
	along with this program. If not, see <http://www.gnu.org/licenses/>.
*/
"use strict";function acui_options_load(){$("#acui_option_maxdepth").val(ai.options.ai.maxDepth),$("#acui_option_maxnodes").val(ai.options.ai.maxNodes),$("#acui_option_minimizeliberty").prop("checked",ai.options.ai.minimizeLiberty),$("#acui_option_maxreply").val(ai.options.ai.maxReply).slider("refresh"),$("#acui_option_nostatonforcedmove").prop("checked",ai.options.ai.noStatOnForcedMove),$("#acui_option_wholenodes").prop("checked",ai.options.ai.wholeNodes),$("#acui_option_randomizedsearch").prop("checked",ai.options.ai.randomizedSearch),$("#acui_option_pessimisticscenario").prop("checked",ai.options.ai.pessimisticScenario),$("#acui_option_beststaticscore").prop("checked",ai.options.ai.bestStaticScore),$("#acui_option_opportunistic").prop("checked",ai.options.ai.opportunistic),$("#acui_option_handicap").val(ai.options.ai.handicap).slider("refresh"),$("#acui_option_acceleratedendgame").prop("checked",ai.options.ai.acceleratedEndGame),$("#acui_option_oyster").prop("checked",ai.options.ai.oyster),$("#acui_option_fischer").val(ai.options.board.fischer),$("#acui_option_rotated").prop("checked",ai.options.board.rotated),$("#acui_option_symbol").prop("checked",ai.options.board.symbols),$("#acui_option_coordinates").prop("checked",ai.options.board.coordinates),$("#acui_option_nostatonownmove").prop("checked",ai.options.board.noStatOnOwnMove),$("#acui_option_decisiontree").prop("checked",ai.options.board.decisionTree),$("#acui_option_fulldecisiontree").prop("checked",ai.options.board.fullDecisionTree),$("#acui_option_debugcellid").prop("checked",ai.options.board.debugCellId),$("#acui_option_enpassant").prop("checked",ai.options.variant.enPassant),$("#acui_option_promotequeen").prop("checked",ai.options.variant.promoteQueen),$("#acui_option_activepawns").prop("checked",ai.options.variant.activePawns),$("#acui_option_pieces").val(ai.options.variant.pieces).change()}function acui_reset_ui(i){ui_rewind=!1,$("#acui_tab_board_header").trigger("click"),$("#acui_valuation").val(0).slider("refresh"),$("#acui_lastmove, #acui_nodes, #acui_depth, #acui_moves, #acui_history, #acui_dtree").html(""),$("#acui_sect_rewind").hide(),$("#acui_pgn").addClass("ui-disabled"),ai.resetStats(),i&&$("#acui_player").val(ai.constants.owner.white).change()}function acui_refresh_board(){if(ui_rewind)return!1;var i=parseInt($("#acui_player").val());return ai.freeMemory(),$("#acui_board").html(ai.toHtml()),$("#acui_board").css("width",(ai.options.board.coordinates?420:400)+"px"),$("#acui_board").css("height",$("#acui_board").css("width")),$(".AntiCrux-board-cell-0, .AntiCrux-board-cell-1, .AntiCrux-board-cell-hl").click(function(){var e=this.dataset.xy;if(!e.match(/^[a-h][1-8]$/))return!1;switch(e==ui_move?ui_move="":2==ui_move.length&&ai.getPieceByCoordinate(ui_move).owner==ai.getPieceByCoordinate(e).owner?ui_move=e:ui_move+=e,ui_move.length){case 4:ai.options.board.noStatOnOwnMove||ai.getMoveAI(i),e=ai.movePiece(ui_move,!0,i),e!=ai.constants.move.none?acui_promote(e):(acui_popup("The move has been denied. Choose another one."),ai.highlight(!0,null),acui_refresh_board()),ai.freeMemory(),ui_move="";break;case 0:case 2:ai.highlight(!0,ui_move),acui_refresh_board();break;default:throw"Internal error - Report any error (#001)"}return!0}),!0}function acui_refresh_moves(){var i,e=parseInt($("#acui_player").val());$("#acui_valuation").val($("#acui_option_pro").prop("checked")?ai.constants.score.neutral:ai.getScore().valuationSolverPC).slider("refresh"),i=ai.getNumNodes(),$("#acui_nodes").html(0===i?"":"Nodes : "+i),i=ai.getReachedDepth(),$("#acui_depth").html(0===i?"":"Depth : "+i),$("#acui_moves").html($("#acui_option_pro").prop("checked")?"<div>No statistic with the professional mode.</div>":ai.getMovesHtml(e)),ai.options.board.decisionTree&&$("#acui_dtree").html(ai.getDecisionTreeHtml())}function acui_refresh_history(i){var e=ai.getHistoryHtml();$("#acui_history").html(e),0===e.length?$("#acui_pgn").addClass("ui-disabled"):$("#acui_pgn").removeClass("ui-disabled"),ui_rewind?$("#acui_sect_rewind").show():$("#acui_sect_rewind").hide(),i&&$("#acui_history_scrollbox").scrollTop(2*$("#acui_history").height()),$(".AntiCrux-history-item").click(function(){var i,e,a=parseInt(this.dataset.index),o=ai.getHistory();if(0===o.length)return!1;if(a<0||a>=o.length)return!1;if(i=new AntiCrux,i.copyOptions(ai),3==i.options.variant.pieces&&(i.options.variant.pieces=0),!i.loadFen(ai.getInitialPosition()))return!1;for(e=0;e<=a;e++){if(i.movePiece(o[e],!1,i.constants.owner.none)==i.constants.move.none)throw"Internal error - Report any error (#002)";i.switchPlayer(),i.highlightMove(o[e])}return acui_reset_ui(!1),ui_rewind=!0,$("#acui_player").val(i.getPlayer()).change(),acui_refresh_history(!1),$("#acui_board").html(i.toHtml()),!0})}function acui_isRewind(){return ui_rewind&&($("#acui_tab_board_history_header").trigger("click"),acui_popup("Leave the review of the game to continue with it.")),ui_rewind}function acui_promote(i){ui_move_pending=i,ai.hasPendingPromotion()?$("#acui_promotion").popup("open",{}):acui_afterHumanMove()}function acui_afterHumanMove(){ui_move="",ai.updateHalfMoveClock(),ai.logMove(ui_move_pending),ui_move_pending=ai.constants.move.none,acui_refresh_history(!0),acui_refresh_board(),ai.isEndGame(!0)?(acui_showWinner(),acui_switch_players()):(acui_switch_players(),$("#acui_option_autoplay").prop("checked")&&(ai.isDraw()?acui_popup("The game ended in a tie.\n\nReason : "+ai.getDrawReason()+"."):(ai.isPossibleDraw()&&!ui_possibledraw&&(acui_popup("The game is a possible draw."),ui_possibledraw=!0),setTimeout(function(){$("#acui_play_ai").click()},1e3))))}function acui_autostart(){ai.getPlayer()==(ai.options.board.rotated?ai.constants.owner.white:ai.constants.owner.black)&&setTimeout(function(){$("#acui_play_ai").click()},500)}function acui_switch_players(){ai.getPlayer()==ai.constants.owner.black?$("#acui_player").val(ai.constants.owner.white).change():$("#acui_player").val(ai.constants.owner.black).change()}function acui_showWinner(){var i=ai.getWinner();if(i==ai.constants.owner.none)throw"Internal error - Report any error (#003)";i=i==ai.constants.owner.white?"White":"Black",acui_popup("End of the game. "+i+" has won !")}function acui_popup(i){setTimeout(function(){$("#acui_popup_text").html(i.split("\n").join("<br/>")),$("#acui_popup").popup("open",{})},750)}var ai=new AntiCrux,ui_move,ui_move_pending,ui_possibledraw,ui_rewind,ui_rematch;ai.options.board.symbols=!0,ai.defaultBoard(),$(document).ready(function(){ui_move="",ui_move_pending=ai.constants.move.none,ui_possibledraw=!1,ui_rewind=!1,ui_rematch=ai.constants.owner.white,acui_refresh_board(),$("#acui_player").find("option").remove().end(),$("<option/>").val(ai.constants.owner.white).html("White to play").appendTo("#acui_player"),$("<option/>").val(ai.constants.owner.black).html("Black to play").appendTo("#acui_player"),$("#acui_player").val(ai.constants.owner.white).change(),$("input[type='text']").on("click",function(){return $(this).select(),!0}),$("#acui_player").change(function(){return ui_rewind||ai.setPlayer(parseInt($("#acui_player").val())),!ui_rewind}),$("#acui_play_ai").click(function(){if(acui_isRewind())return!1;var i=parseInt($("#acui_player").val()),e=ai.getMoveAI(i);if(e==ai.constants.move.none)return ai.isEndGame(!1)&&acui_showWinner(),!0;if($("#acui_lastmove").html("Last move : "+ai.moveToString(e)),acui_refresh_moves(),ai.movePiece(e,!0,i)==ai.constants.move.none)throw"Internal error - Report any error (#004)";return ui_move="",ai.updateHalfMoveClock(),ai.logMove(e),acui_refresh_history(!0),ai.highlightMove(e),ai.isEndGame(!0)?acui_showWinner():ai.isDraw()&&acui_popup("The game ended in a tie.\n\nReason : "+ai.getDrawReason()+"."),acui_refresh_board(),acui_switch_players(),!0}),$("#acui_play_human").click(function(){if(acui_isRewind())return!1;var i=parseInt($("#acui_player").val()),e=window.prompt("Type your move :","0");return null===e?(acui_popup("No move has been considered."),!1):(ai.options.board.noStatOnOwnMove||(ai.getMoveAI(i),acui_refresh_moves()),e=ai.movePiece(e,!0,i),e!=ai.constants.move.none?acui_promote(e):acui_popup("The move has been denied. Choose another one."),ai.freeMemory(),!0)}),$("#acui_play_hint_soft").click(function(){return!ui_rewind&&(ui_move="",ai.highlightMoves(!0),acui_refresh_board(),!0)}),$("#acui_play_hint_hard").click(function(){return!ui_rewind&&(ai.getMoveAI(parseInt($("#acui_player").val())),ui_move="",ai.highlightMoves(!1),acui_refresh_moves(),acui_refresh_board(),ai.freeMemory(),!0)}),$("#acui_play_hint_irma").click(function(){return!ui_rewind&&(acui_popup(ai.predictMoves().split("\n").join("<br/>")),!0)}),$("#acui_play_undo").click(function(){if(acui_isRewind())return!1;var i;return ai.undoMove()?(ui_move="",ui_possibledraw=!1,acui_reset_ui(!1),acui_refresh_moves(),acui_refresh_history(!0),i=ai.getHistory(),i.length>0&&ai.highlightMove(i[i.length-1]),acui_refresh_board()):acui_popup("Impossible to undo because there is not enough history."),$("#acui_player").val(ai.getPlayer()).change(),!0}),$("#acui_rewind").click(function(){return!!ui_rewind&&(acui_reset_ui(!1),$("#acui_player").val(ai.getPlayer()).change(),acui_refresh_board(),acui_refresh_history(!0),!0)}),$("#acui_pgn").click(function(){var i,e;return e=ai.toPgn({}),0===e.length?acui_popup("No data to export to PGN."):(i=document.createElement("a"),i.setAttribute("href","data:application/x-chess-pgn;charset=iso-8859-1,"+encodeURIComponent(e)),i.setAttribute("download","anticrux_"+(new Date).toISOString().slice(0,10)+"_"+(new Date).toLocaleTimeString().replace(/[^0-9]/g,"")+".pgn"),i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i)),!0}),$(".AntiCrux-board-promotion").click(function(){var i=ai.promote(this.dataset.promotion);return i!=ai.constants.piece.none&&(ui_move_pending+=1e4*i,acui_afterHumanMove(),!0)}),$("#acui_clear").click(function(){return ai.clearBoard(),ui_move="",ui_possibledraw=!1,acui_reset_ui(!0),acui_refresh_board(),!0}),$("#acui_default").click(function(){return ai.defaultBoard(),ui_move="",ui_possibledraw=!1,acui_reset_ui(!0),acui_refresh_board(),acui_autostart(),!0}),$("#acui_fischer_new").click(function(){return $("#acui_option_fischer").dblclick(),$("#acui_fischer_current").click(),acui_popup("You are playing AntiChess "+ai.fischer+"."),!0}),$("#acui_fischer_current").click(function(){return ai.defaultBoard(ai.options.board.fischer),ui_move="",ui_possibledraw=!1,acui_reset_ui(!0),acui_refresh_board(),acui_autostart(),!0}),$("#acui_rematch").click(function(){ui_rematch=ui_rematch==ai.constants.owner.white?ai.constants.owner.black:ai.constants.owner.white,$("#acui_option_rotated").prop("checked",ui_rematch==ai.constants.owner.black).checkboxradio("refresh").change(),null!==ai.fischer?ai.fischer==ai.constants.board.classicalFischer?$("#acui_default").click():$("#acui_fischer_current").click():ai.hasSetUp()?(ui_move="",$("#acui_input").val(ai.getInitialPosition()),$("#acui_fen_load").click(),acui_autostart()):$("#acui_default").click()}),$("#acui_fen_load").click(function(){var i;return ai.loadFen($("#acui_input").val())?(i=ai.getPlayer(),ui_move="",ui_possibledraw=!1,acui_reset_ui(!0),acui_refresh_board(),$("#acui_tab_board_header").trigger("click"),$("#acui_player").val(i).change(),null!==ai.fischer&&($("#acui_option_fischer").val(ai.fischer).change(),ai.fischer!=ai.constants.board.classicalFischer&&acui_popup("You are playing AntiChess "+ai.fischer+".")),!0):(acui_popup("The FEN cannot be loaded because it has a wrong format."),!1)}),$("#acui_fen_gen").click(function(){return $("#acui_input").val(ai.toFen()).focus().click(),!0}),$("#acui_lichess_load").click(function(){var i;return ai.loadLichess($("#acui_input").val())?($("#acui_tab_board_header").trigger("click"),$("#acui_board").html("Please wait few seconds while the game is loaded..."),setTimeout(function(){i=ai.getPlayer(),ui_move="",ui_possibledraw=!1,acui_reset_ui(!0),acui_refresh_board(),acui_refresh_history(!0),$("#acui_player").val(i).change(),null!==ai.fischer&&($("#acui_option_fischer").val(ai.fischer).change(),ai.fischer!=ai.constants.board.classicalFischer&&acui_popup("You are playing AntiChess "+ai.fischer+"."))},5e3),!0):(acui_popup("The game cannot be retrieved from Lichess.org. Please never abuse."),!1)}),$("#acui_text_gen").click(function(){return $("#acui_input").val(ai.toText()).focus().click(),!0}),$("#acui_free").click(function(){return ai.freeMemory(),!0}),$("#acui_option_predef").change(function(){var i,e,a=[{maxDepth:50,maxNodes:1e6,wholeNodes:!0,minimizeLiberty:!0,maxReply:2,noStatOnForcedMove:!0,randomizedSearch:!0,oyster:!1,pessimisticScenario:!0,bestStaticScore:!0,opportunistic:!0,handicap:0,acceleratedEndGame:!0},{maxDepth:40,maxNodes:5e5,wholeNodes:!0,minimizeLiberty:!0,maxReply:2,noStatOnForcedMove:!0,randomizedSearch:!0,oyster:!1,pessimisticScenario:!0,bestStaticScore:!0,opportunistic:!0,handicap:0,acceleratedEndGame:!0},{maxDepth:30,maxNodes:2e5,wholeNodes:!0,minimizeLiberty:!0,maxReply:2,noStatOnForcedMove:!0,randomizedSearch:!0,oyster:!1,pessimisticScenario:!0,bestStaticScore:!0,opportunistic:!0,handicap:0,acceleratedEndGame:!0},{maxDepth:10,maxNodes:9e4,wholeNodes:!0,minimizeLiberty:!0,maxReply:1,noStatOnForcedMove:!0,randomizedSearch:!0,oyster:!1,pessimisticScenario:!0,bestStaticScore:!1,opportunistic:!1,handicap:0,acceleratedEndGame:!0},{maxDepth:7,maxNodes:75e3,wholeNodes:!1,minimizeLiberty:!1,maxReply:1,noStatOnForcedMove:!1,randomizedSearch:!0,oyster:!1,pessimisticScenario:!1,bestStaticScore:!1,opportunistic:!1,handicap:0,acceleratedEndGame:!0},{maxDepth:3,maxNodes:15e3,wholeNodes:!1,minimizeLiberty:!1,maxReply:1,noStatOnForcedMove:!1,randomizedSearch:!0,oyster:!1,pessimisticScenario:!1,bestStaticScore:!1,opportunistic:!1,handicap:0,acceleratedEndGame:!0},{maxDepth:7,maxNodes:5e4,wholeNodes:!1,minimizeLiberty:!1,maxReply:1,noStatOnForcedMove:!1,randomizedSearch:!0,oyster:!1,pessimisticScenario:!1,bestStaticScore:!1,opportunistic:!1,handicap:70,acceleratedEndGame:!0},{maxDepth:3,maxNodes:100,wholeNodes:!1,minimizeLiberty:!1,maxReply:1,noStatOnForcedMove:!1,randomizedSearch:!0,oyster:!0,pessimisticScenario:!1,bestStaticScore:!1,opportunistic:!1,handicap:0,acceleratedEndGame:!1}];if(i=parseInt($("#acui_option_predef").val()),void 0===a[i])return!1;for(e in a[i])ai.options.ai[e]=a[i][e];return acui_options_load(),$("input[type='checkbox']").checkboxradio("refresh"),!0}),$("#acui_option_maxreply").change(function(){return $("#acui_option_minimizeliberty").prop("checked",!0).checkboxradio("refresh"),!0}),$("#acui_option_fischer").dblclick(function(){return $("#acui_option_fischer").val(ai.getNewFischerId()).change(),!0}),$("#acui_option_fulldecisiontree").change(function(){return $("#acui_option_fulldecisiontree").prop("checked")&&$("#acui_option_decisiontree").prop("checked",!0).checkboxradio("refresh"),!0}),$(".AntiCrux-ui-option").change(function(){return ai.options.ai.maxDepth=parseInt($("#acui_option_maxdepth").val()),ai.options.ai.maxNodes=parseInt($("#acui_option_maxnodes").val()),ai.options.ai.minimizeLiberty=$("#acui_option_minimizeliberty").prop("checked"),ai.options.ai.maxReply=parseInt($("#acui_option_maxreply").val()),ai.options.ai.noStatOnForcedMove=$("#acui_option_nostatonforcedmove").prop("checked"),ai.options.ai.wholeNodes=$("#acui_option_wholenodes").prop("checked"),ai.options.ai.randomizedSearch=$("#acui_option_randomizedsearch").prop("checked"),ai.options.ai.pessimisticScenario=$("#acui_option_pessimisticscenario").prop("checked"),ai.options.ai.bestStaticScore=$("#acui_option_beststaticscore").prop("checked"),ai.options.ai.opportunistic=$("#acui_option_opportunistic").prop("checked"),ai.options.ai.handicap=parseInt($("#acui_option_handicap").val()),ai.options.ai.acceleratedEndGame=$("#acui_option_acceleratedendgame").prop("checked"),ai.options.ai.oyster=$("#acui_option_oyster").prop("checked"),ai.options.board.fischer=parseInt($("#acui_option_fischer").val()),ai.options.board.rotated=$("#acui_option_rotated").prop("checked"),ai.options.board.symbols=$("#acui_option_symbol").prop("checked"),ai.options.board.coordinates=$("#acui_option_coordinates").prop("checked"),ai.options.board.noStatOnOwnMove=$("#acui_option_nostatonownmove").prop("checked"),ai.options.board.decisionTree=$("#acui_option_decisiontree").prop("checked"),ai.options.board.fullDecisionTree=$("#acui_option_fulldecisiontree").prop("checked"),ai.options.board.debugCellId=$("#acui_option_debugcellid").prop("checked"),ai.options.variant.enPassant=$("#acui_option_enpassant").prop("checked"),ai.options.variant.promoteQueen=$("#acui_option_promotequeen").prop("checked"),ai.options.variant.activePawns=$("#acui_option_activepawns").prop("checked"),ai.options.variant.pieces=parseInt($("#acui_option_pieces").val()),!0}),$(".AntiCrux-ui-option-refresh").change(function(){return acui_refresh_board(),!0}),$("#acui_js, #acui_sect_rewind").hide(),$("#acui_option_predef").val(5).change(),$("#acui_version").html(ai.options.ai.version),$(document).on("selectstart",!1)});