/*
	AntiCrux - Artificial intelligence playing AntiChess and AntiChess960 with jQuery Mobile and Node.js
	Copyright (C) 2016-2017, ecrucru

		https://github.com/ecrucru/anticrux/
		http://ecrucru.free.fr/?page=anticrux

	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU Affero General Public License as
	published by the Free Software Foundation, either version 3 of the
	License, or (at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
	GNU Affero General Public License for more details.

	You should have received a copy of the GNU Affero General Public License
	along with this program. If not, see <http://www.gnu.org/licenses/>.
*/
"use strict";var AntiCrux=function(){this._init(),this._root_node={},this._lastLevel=null,this.clearBoard()};AntiCrux.prototype.startUI=function(){if("undefined"==typeof module||!module.exports)throw"Error - AntiCrux.prototype.startUI() is restricted to Node.js";var t=require("opn");t("./node_modules/anticrux/index.html")},AntiCrux.prototype.copyOptions=function(t){return!!t.hasOwnProperty("options")&&(this.options=JSON.parse(JSON.stringify(t.options)),!0)},AntiCrux.prototype.getMainNode=function(){return this._root_node},AntiCrux.prototype.clearBoard=function(){var t;for(this.freeMemory(),this._buffer="",this._highlight=[],this._history=[],this._history_fen0="",this._halfmoveclock=0,this._halfmoveclock_status=-1,this._root_node={piece:[],owner:[],player:this.constants.owner.white},t=0;t<64;t++)this._root_node.piece[t]=this.constants.piece.none,this._root_node.owner[t]=this.constants.owner.none;this.fischer=null},AntiCrux.prototype.getNewFischerId=function(){return Math.floor(960*Math.random())+1},AntiCrux.prototype.defaultBoard=function(t){var e,o,n,s,i;if(void 0===t&&(t=this.constants.board.classicalFischer),t<1||t>960)return!1;for(this.clearBoard(),this.fischer=t,i=[this.constants.piece.none,this.constants.piece.none,this.constants.piece.none,this.constants.piece.none,this.constants.piece.none,this.constants.piece.none,this.constants.piece.none,this.constants.piece.none],i[Math.floor(.08*(Math.floor(25*(t-1))%100)+1.5)]=this.constants.piece.bishop,i[Math.floor(.08*(Math.floor(25*Math.floor((t-1)/4))%100)+.5)]=this.constants.piece.bishop,o=Math.floor(Math.floor((t-1)/4)/4)/6,n=Math.floor(6*(o-Math.floor(o))+.5),e=0;e<8;e++)if(i[e]==this.constants.piece.none){if(0===n){i[e]=this.constants.piece.queen;break}n--}for(s=["NNRKR","NRNKR","NRKNR","NRKRN","RNNKR","RNKNR","RNKRN","RKNNR","RKNRN","RKRNN"][Math.floor(o)],e=0;e<8;e++)i[e]==this.constants.piece.none&&(i[e]=this.constants.piece.mapping[s.charAt(0)],s=s.substring(1));for(e=0;e<8;e++)this._root_node.piece[0+e]=i[e],this._root_node.piece[8+e]=this.constants.piece.pawn,this._root_node.piece[48+e]=this.constants.piece.pawn,this._root_node.piece[56+e]=i[e],this._root_node.owner[0+e]=this.constants.owner.black,this._root_node.owner[8+e]=this.constants.owner.black,this._root_node.owner[48+e]=this.constants.owner.white,this._root_node.owner[56+e]=this.constants.owner.white;return this._history_fen0=this.toFen(),!0},AntiCrux.prototype.loadFen=function(t){var e,o,n,s,i;if(0===t.length)return!1;for(this.clearBoard(),e=t.split(" "),o=0,n=0,s=0;s<e[0].length&&(i=e[0].charAt(s)," "!=i);s++)if("12345678".indexOf(i)!=-1)o+=parseInt(i);else if("/"==i)o=0,n++;else{if("prnbqk".indexOf(i.toLowerCase())==-1)return this.clearBoard(),!1;this._root_node.piece[8*n+o]=this.constants.piece.mapping[i],this._root_node.owner[8*n+o]=i==i.toLowerCase()?this.constants.owner.black:this.constants.owner.white,o++}return void 0===e[1]?this._root_node.player=this.constants.owner.white:this._root_node.player="b"==e[1]?this.constants.owner.black:this.constants.owner.white,this.options.variant.enPassant&&void 0!==e[3]&&"-"!==e[3]&&(s="abcdefgh".indexOf(e[3]),s!==-1&&(this._root_node.enpassant=8*(this._root_node.player==this.constants.owner.white?2:5)+s)),this._halfmoveclock=void 0!==e[4]?parseInt(e[4]):0,this._halfmoveclock_status=-1,this._root_node.valuation=this._ai_nodeValuate().valuation,this._history_fen0=this.toFen(),this.fischer=this._discoverFischer(),!0},AntiCrux.prototype.loadLichess=function(t){var e;return!(!t.match(/^[a-zA-Z0-9]{8}$/)&&!t.match(/^[a-zA-Z0-9]{12}$/))&&(e=this,$.ajaxSetup({cache:!1}),$.get("https://en.lichess.org/api/game/"+t+"?with_fens=1&with_moves=1",function(t){}).fail(function(t){}).done(function(t){var o,n,s,i;if(!e._has(t,"variant","antichess"))return!1;if(e._has(t,"initialFen",!0)){if(!e.loadFen(t.initialFen))return!1}else e.defaultBoard(e.constants.board.classicalFischer);for(s=e._has(t,"color","black")?e.constants.owner.black:e.constants.owner.white,o=t.moves.split(" "),s=s==e.constants.owner.white&&o.length%2==1?e.constants.owner.black:e.constants.owner.white,e._history=[],i=0;i<o.length;i++){if(n=e.movePiece(o[i],!0,s),n==e.constants.move.none)return!1;e.updateHalfMoveClock(),e.logMove(n),e.highlightMove(n),s=s==e.constants.owner.white?e.constants.owner.black:e.constants.owner.white}return e._root_node.player=s,!0}),!0)},AntiCrux.prototype.hasSetUp=function(){return!!this._has(this,"_history_fen0",!0)&&"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR"!=this._history_fen0.substring(0,43)},AntiCrux.prototype.getInitialPosition=function(){return this._has(this,"_history_fen0",!0)?this._history_fen0:""},AntiCrux.prototype.getPlayer=function(t){return void 0===t&&(t=this._root_node),t.hasOwnProperty("player")?t.player:this.constants.owner.none},AntiCrux.prototype.getOppositePlayer=function(t){switch(this.getPlayer(t)){case this.constants.owner.none:return this.constants.owner.none;case this.constants.owner.white:return this.constants.owner.black;case this.constants.owner.black:return this.constants.owner.white;default:return null}},AntiCrux.prototype.setLevel=function(t){return!(t<1||t>20)&&(this.options.ai.maxDepth=[3,8,8,8,3,5,6,7,8,9,10,15,20,30,30,30,40,40,45,50][t-1],this.options.ai.maxNodes=[100,5e4,5e4,5e4,15e3,3e4,5e4,75e3,8e4,85e3,9e4,12e4,15e4,2e5,3e5,4e5,5e5,75e4,1e6,2e6][t-1],this.options.ai.minimizeLiberty=t>=8,this.options.ai.maxReply=[1,1,1,1,1,1,1,3,2,1,1,1,1,2,2,2,2,2,2,2][t-1],this.options.ai.noStatOnForcedMove=t>=6,this.options.ai.wholeNodes=t>=11,this.options.ai.randomizedSearch=!0,this.options.ai.pessimisticScenario=t>=10,this.options.ai.bestStaticScore=t>=12,this.options.ai.opportunistic=t>=13,this.options.ai.handicap=[0,70,50,25,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0][t-1],this.options.ai.acceleratedEndGame=t>=5,this.options.ai.oyster=1==t,this._lastLevel=t,!0)},AntiCrux.prototype.setPlayer=function(t,e){return void 0===e&&(e=this._root_node),[this.constants.owner.black,this.constants.owner.none,this.constants.owner.white].indexOf(t)!==-1&&(e.player=t,!0)},AntiCrux.prototype.getPieceByCoordinate=function(t,e){var o;return!!t.match(/^[a-h][1-8]$/)&&(void 0===e&&(e=this._root_node),o=8*(8-parseInt(t.charAt(1)))+"abcdefgh".indexOf(t.charAt(0)),{owner:e.owner[o],piece:e.piece[o]})},AntiCrux.prototype.isMove=function(t){return t.match(/^[RNBQK]?([a-h]([0-9])?)?x?[a-h][0-9]=?[RrNnBbQqKk]?\s?[\!|\+|\#|\-|\/|\=|\?]*$/)||t.match(/^[0-6]?[0-7]{4}$/)},AntiCrux.prototype.movePiece=function(t,e,o,n){var s,i,a,r,h,c,p,l,u,d,v,f,_,w,y;if(void 0===t||t==this.constants.move.none)return this.constants.move.none;if(void 0===n&&(n=this._root_node),this.hasPendingPromotion(n))return this.constants.move.none;if(void 0===o&&(o=this.constants.owner.none),null===n)return this.constants.move.none;if("string"==typeof t){if(s=t.match(/^([RNBQK])?([a-h]([0-9])?)?(x)?([a-h][0-9])=?([RrNnBbQqKk])?\s?[\!|\+|\#|\-|\/|\=|\?]*$/),null===s)return this.constants.move.none;for(h=0;h<s.length;h++)void 0===s[h]&&(s[h]="");for(v=s[6].length>0?this.constants.piece.mapping[s[6]]:this.constants.piece.none,y="abcdefgh".indexOf(s[5].charAt(0)),w=8-parseInt(s[5].charAt(1)),a=this._ai_nodeCopy(n,!1),r=[],o==this.constants.owner.none?(a.player=this.constants.owner.black,this._ai_nodeMoves(a),r=r.concat(a.moves),a.player=this.constants.owner.white,this._ai_nodeMoves(a),a.moves=r.concat(a.moves)):(a.player=o,this._ai_nodeMoves(a)),r=[],h=0;h<a.moves.length;h++)if(a.moves[h]%100==10*w+y){if(c=Math.floor(a.moves[h]/100)%10,p=Math.floor(a.moves[h]/1e3)%10,v!=this.constants.piece.none&&Math.floor(a.moves[h]/1e4)%10!=v)continue;if(o!=this.constants.owner.none&&a.owner[8*p+c]!=o)continue;if(1==s[2].length&&s[2]!="abcdefgh".charAt(c))continue;if(2==s[2].length&&(s[2][0]!="abcdefgh".charAt(c)||8-parseInt(s[2][1])!=p))continue;if(1==s[1].length&&this.constants.piece.mapping[s[1]]!=a.piece[8*p+c])continue;if(0===s[1].length&&2!=s[2].length&&a.piece[8*p+c]!=this.constants.piece.pawn)continue;r.indexOf(a.moves[h]%1e4)==-1&&r.push(a.moves[h]%1e4)}if(1!=r.length)return this.constants.move.none;f=Math.floor(r[0]/1e3)%10,_=Math.floor(r[0]/100)%10}else{if(t=parseInt(t),0===t)return this.constants.move.none;v=Math.floor(t/1e4)%10,f=Math.floor(t/1e3)%10,_=Math.floor(t/100)%10,w=Math.floor(t/10)%10,y=t%10}if(_<0||_>7||f<0||f>7||y<0||y>7||w<0||w>7||v>this.constants.piece.king)return this.constants.move.none;if(t=1e4*v+1e3*f+100*_+10*w+y,i=n.owner[8*f+_],i==this.constants.owner.none)return this.constants.move.none;if(n.player=i,e){for(a=this._ai_nodeCopy(n,!1),a.player=i,this._ai_nodeMoves(a),d=!1,h=0;h<a.moves.length;h++)if(t==a.moves[h]||t==a.moves[h]%1e4){d=!0;break}if(!d)return this._highlight=[],this.constants.move.none}return this.options.variant.enPassant&&n.hasOwnProperty("enpassant")&&8*w+y==n.enpassant&&n.piece[8*f+_]==this.constants.piece.pawn&&n.piece[8*w+y]==this.constants.piece.none?(l=y,u=w+n.player,l>=0&&l<=7&&u>=0&&u<=7&&n.piece[8*u+l]==this.constants.piece.pawn&&n.owner[8*u+l]!=n.owner[8*f+_]&&(n.piece[8*u+l]=this.constants.piece.none,n.owner[8*u+l]=this.constants.owner.none,delete n.enpassant)):n.piece[8*f+_]==this.constants.piece.pawn&&2==Math.abs(w-f)?n.enpassant=4*(w+f)+y:delete n.enpassant,this._halfmoveclock_status=1,n.piece[8*f+_]!=this.constants.piece.pawn&&n.piece[8*w+y]==this.constants.piece.none||(this._halfmoveclock_status=0),n.piece[8*w+y]=n.piece[8*f+_],n.piece[8*f+_]=this.constants.piece.none,n.owner[8*w+y]=n.owner[8*f+_],n.owner[8*f+_]=this.constants.owner.none,0!==w&&7!==w||n.piece[8*w+y]==this.constants.piece.pawn&&(this.options.variant.promoteQueen&&(v=this.constants.piece.queen),v!=this.constants.piece.none?n.piece[8*w+y]=v:n._pendingPromotion=8*w+y),this._highlight=[],t},AntiCrux.prototype.getMoveAI=function(t,e){var o,n,s,i,a,r,h,c,p,l,u,d,v;if(void 0===e&&(e=this._root_node),void 0===t&&(t=this.getPlayer(e)),t!=this.constants.owner.black&&t!=this.constants.owner.white)return this.constants.move.none;if(this._buffer="",this.hasPendingPromotion(e))return this.constants.move.none;if(this.options.ai.maxReply<1&&(this.options.ai.maxReply=1),this._ai_nodeFreeMemory(e),this._ai_nodeShrink(e),e.player=t,n=this.options.ai.maxDepth,this._ai_nodeMoves(e),0===e.moves.length)return this.constants.move.none;if(i=this.options.ai.noStatOnForcedMove&&1===e.moves.length,this.options.ai.oyster)return this.resetStats(),e.moves[Math.round(Math.random()*(e.moves.length-1))];for(a=[],r=[],s=1;s<=n;s++){if(this._numNodes=0,this.options.ai.maxDepth=s,this._ai_nodeRecurseTree(t,0,e),this._reachedDepth=s,null!==this.callbackExploration&&this.callbackExploration(n,this._reachedDepth,this._numNodes),0===this._numNodes)throw"Internal error - Report any error (#001)";for(a.push(s),r.push(this._numNodes),h=0,c=0,o=0;o<a.length;o++)h+=a[o];for(h/=a.length,o=0;o<r.length;o++)c+=Math.log(r[o]);for(c/=r.length,p=0,o=0;o<a.length;o++)p+=Math.pow(a[o]-h,2);for(p/=a.length,l=0,o=0;o<r.length;o++)l+=(a[o]-h)*(Math.log(r[o])-c);if(l/=r.length,d=0===p?0:l/p,u=Math.exp(c-d*h),v=Math.floor(u*Math.exp(d*(s+1))),s>=(i?1:n)||!this.options.ai.wholeNodes&&0!==this.options.ai.maxNodes&&v>this.options.ai.maxNodes||this.options.ai.wholeNodes&&0!==this.options.ai.maxNodes&&this._numNodes>=this.options.ai.maxNodes)break}return this.options.ai.maxDepth=n,this._ai_gc(),this._ai_nodeSolve(t,0,"",e),this._ai_nodePick(t,e)},AntiCrux.prototype.predictMoves=function(t){var e,o,n,s;if(void 0===t&&(t=this._root_node),this.hasPendingPromotion(t))return"Error : the position is waiting for a promotion.";if(this._ai_nodeFreeMemory(t),e=new AntiCrux,e.options.ai.maxDepth=3,e.options.ai.maxNodes=0,e.options.ai.wholeNodes=!0,e.options.board.symbols=this.options.board.symbols,!e.loadFen(this.toFen(t)))return"Error : the position cannot be loaded.";if(e._ai_nodeMoves(e._root_node),0===e._root_node.moves.length)return"The game is over.";for(s="",n=0;n<5;n++){if(o=e.getMoveAI(),o===e.constants.move.none){e.freeMemory();break}if(s.length>0&&(s+=" "),s+=e.moveToString(o),e.freeMemory(),e.movePiece(o,!0)==e.constants.move.none)throw"Internal error - Report any error (#012)";e.switchPlayer()}return"The predicted moves are :\n"+s+"\n\nScore = "+e.getScore().valuationSolverPC+"%"},AntiCrux.prototype.logMove=function(t){return void 0!==t&&0!==t&&("number"==typeof t&&(this._history.push(t),!0))},AntiCrux.prototype.getHalfMoveClock=function(){return this._halfmoveclock},AntiCrux.prototype.updateHalfMoveClock=function(){1==this._halfmoveclock_status?this._halfmoveclock++:0===this._halfmoveclock_status&&(this._halfmoveclock=0),this._halfmoveclock_status=-1},AntiCrux.prototype.resetStats=function(){this._numNodes=0,this._reachedDepth=0},AntiCrux.prototype.undoMove=function(){var t,e;if(!this._has(this,"_history",!0)||!this._has(this,"_history_fen0",!0))return"";for(e=this._history.slice(0),e.pop(),this.loadFen(this._history_fen0),t=0;t<e.length;t++){if(this.movePiece(e[t],!0,this.constants.owner.none)==this.constants.move.none)throw"Internal error - Report any error (#004)";this.updateHalfMoveClock(),this.switchPlayer()}return this._history=e,!0},AntiCrux.prototype.getNumNodes=function(){return this.hasOwnProperty("_numNodes")?this._numNodes:0},AntiCrux.prototype.getReachedDepth=function(){return this.hasOwnProperty("_reachedDepth")?this._reachedDepth:0},AntiCrux.prototype.hasPendingPromotion=function(t){return void 0===t&&(t=this._root_node),t.hasOwnProperty("_pendingPromotion")},AntiCrux.prototype.promote=function(t,e){var o;if(void 0===e&&(e=this._root_node),!this.hasPendingPromotion(e))return this.constants.piece.none;if("string"==typeof t){if(!this.constants.piece.mapping.hasOwnProperty(t))return this.constants.piece.none;o=this.constants.piece.mapping[t]}return this.options.variant.promoteQueen&&(o=this.options.piece.queen),e.piece[e._pendingPromotion]=o,delete e._pendingPromotion,o},AntiCrux.prototype.getPieceSymbol=function(t,e,o){var n;if(o){if(e==this.constants.owner.white)switch(t){case this.constants.piece.pawn:n="&#9817;";break;case this.constants.piece.rook:n="&#9814;";break;case this.constants.piece.knight:n="&#9816;";break;case this.constants.piece.bishop:n="&#9815;";break;case this.constants.piece.queen:n="&#9813;";break;case this.constants.piece.king:n="&#9812;";break;default:n=""}else switch(t){case this.constants.piece.pawn:n="&#9823;";break;case this.constants.piece.rook:n="&#9820;";break;case this.constants.piece.knight:n="&#9822;";break;case this.constants.piece.bishop:n="&#9821;";break;case this.constants.piece.queen:n="&#9819;";break;case this.constants.piece.king:n="&#9818;";break;default:n=""}return 0===n.length?"":'<span class="AntiCrux-big">'+n+"</span>"}return t==this.constants.piece.pawn?"":this.constants.piece.mapping_rev[t].toUpperCase()},AntiCrux.prototype.moveToString=function(t,e){var o,n,s,i,a,r,h,c,p;return void 0===e&&(e=this._root_node),null===t||t==this.constants.move.none?"":(o=parseInt(t),n=Math.floor(o/1e4)%10,s=Math.floor(o/1e3)%10,i=Math.floor(o/100)%10,a=Math.floor(o/10)%10,r=o%10,p=this.getPieceSymbol(e.piece[8*s+i],e.owner[8*s+i],this.options.board.symbols),c=e.owner[8*a+r]!=e.owner[8*s+i]&&e.owner[8*a+r]!=this.constants.owner.none,e.hasOwnProperty("enpassant")&&this.options.variant.enPassant&&(c=c||e.piece[8*s+i]==this.constants.piece.pawn&&8*a+r==e.enpassant),this._ai_nodeInventory(e.owner[8*s+i],e.piece[8*s+i],void 0,e)>1||c&&e.piece[8*s+i]==this.constants.piece.pawn?(h="abcdefgh".charAt(i),this._ai_nodeInventory(e.owner[8*s+i],e.piece[8*s+i],i,e)>1&&(h+=8-s)):h="",c||e.piece[8*s+i]!=this.constants.piece.pawn||i!=r||(h=""),c||1!=this._ai_nodeInventory(e.owner[8*s+i],e.piece[8*s+i],void 0,e)||(h=""),c&&(h+="x"),p+=h,p+="abcdefgh".charAt(r),p+=8-a,n!=this.constants.piece.none&&(p+="="+this.getPieceSymbol(n,e.owner[8*s+i],this.options.board.symbols)),p)},AntiCrux.prototype.moveToUCI=function(t){return null===t||"number"!=typeof t||t==this.constants.move.none?"0000":("abcdefgh"[Math.floor(t/100)%10]+(8-Math.floor(t/1e3)%10)+"abcdefgh"[t%10]+(8-Math.floor(t/10)%10)+"  rnbqk"[Math.floor(t/1e4)%10]).trim()},AntiCrux.prototype.getScore=function(t){var e;return void 0===t&&(t=this._root_node),e=this._ai_nodeValuate(t),null===e?{valuation:t.hasOwnProperty("valuation")?t.valuation:null,valuationSolver:t.hasOwnProperty("valuationSolver")?t.valuationSolver:null}:e},AntiCrux.prototype.switchPlayer=function(t){return void 0===t&&(t=this._root_node),!!t.hasOwnProperty("player")&&(t.player==this.constants.owner.white?t.player=this.constants.owner.black:t.player=this.constants.owner.white,!0)},AntiCrux.prototype.getWinner=function(t){var e=this._ai_nodeCopy(void 0===t?this._root_node:t,!0);return e.player=this.constants.owner.white,this._ai_nodeMoves(e),this._has(e,"moves",!0)?(e.player=this.constants.owner.black,this._ai_nodeMoves(e),this._has(e,"moves",!0)?this.constants.owner.none:this.constants.owner.black):this.constants.owner.white},AntiCrux.prototype.isDraw=function(t){return void 0===t&&(t=this._root_node),this._halfmoveclock>=50||!!(this.hasOwnProperty("_reachedDepth")&&t.hasOwnProperty("valuation")&&t.hasOwnProperty("valuationSolver"))&&(this._reachedDepth>=5&&0===t.valuation&&0===t.valuationSolver&&this._ai_nodeInventory(this.constants.owner.black,null,void 0,t)<=5&&this._ai_nodeInventory(this.constants.owner.white,null,void 0,t)<=5)},AntiCrux.prototype.isEndGame=function(t,e){var o=this._ai_nodeCopy(void 0===e?this._root_node:e,!1);return t&&this.switchPlayer(o),this._ai_nodeMoves(o),!this._has(o,"moves",!0)},AntiCrux.prototype.highlight=function(t,e){if(void 0===e&&(e=null),(t||null===e)&&(this._highlight=[]),null===e);else if(Array.isArray(e))this._highlight=this._highlight.concat(e);else if("string"!=typeof e)this._highlight.push(parseInt(e));else if(0===e.length);else if(e.match(/^[a-h][1-8]$/))this._highlight.push(8*(8-parseInt(e.charAt(1)))+"abcdefgh".indexOf(e.charAt(0)));else{if(!e.match(/^[0-7]{2}$/))return!1;this._highlight.push(parseInt(e))}return!0},AntiCrux.prototype.highlightMove=function(t){var e,o,n,s;0===t?this._highlight=[]:(e=Math.floor(t/1e3)%10,o=Math.floor(t/100)%10,n=Math.floor(t/10)%10,s=t%10,this._highlight=[8*e+o,8*n+s])},AntiCrux.prototype.highlightMoves=function(t){var e,o,n;if(this._highlight=[],t?(e=this._ai_nodeCopy(this._root_node,!1),this._ai_nodeMoves(e)):e=this._root_node,1==e.moves.length)this.highlightMove(e.moves[0]);else for(o=0;o<e.moves.length;o++)n=e.moves[o]%100,this._highlight.push(8*Math.floor(n/10)+n%10)},AntiCrux.prototype.getHistory=function(){return this.hasOwnProperty("_history")?this._history:[]},AntiCrux.prototype.getHistoryHtml=function(){var t,e,o;if(!this._has(this,"_history",!0)||!this._has(this,"_history_fen0",!0))return"";if(t=new AntiCrux,t.copyOptions(this),!t.loadFen(this._history_fen0))return"";for(o='<table class="ui-table AntiCrux-table" data-role="table">',e=0;e<this._history.length;e++){if(e%2===0&&(o+="<tr><th>"+Math.floor((e+2)/2)+"</th>"),o+='<td class="AntiCrux-history-item" data-index="'+e+'" title="Click to review this past move">'+t.moveToString(this._history[e])+"</td>",t.movePiece(this._history[e],!0,t.constants.owner.none)==t.constants.move.none)throw"Internal error - Report any error (#010)";e%2==1&&(o+="</tr>")}return e%2==1&&(o+="</tr>"),o+"</table>"},AntiCrux.prototype.getDecisionTreeHtml=function(t){return void 0===t&&(t=this._root_node),this._buffer="",this._ai_nodeTreeHtml(0,t),0===this._buffer.length&&(this._buffer='<tr><td colspan="7">No data</td></tr>'),'<table class="ui-table AntiCrux-table" data-role="table">\t<thead>\t\t<tr>\t\t\t<th>Static</th>\t\t\t<th>Deep</th>\t\t\t<th colspan="5">Moves</th>\t\t</tr>\t</thead>\t<tbody>\n'+this._buffer+"\t</tbody></table>"},AntiCrux.prototype.getMovesHtml=function(t,e){var o,n,s;if(void 0===e&&(e=this._root_node),!this._has(e,"nodes",!0)||!this._has(e,"moves",!0))return"";for(n="",o=0;o<e.moves.length;o++){if(n+="<tr><td>"+this.moveToString(e.moves[o],e)+"</td>",s=this._ai_nodeValuate(e.nodes[o]),n+="<td>",n+=s.valuation==this.constants.owner.black*this.constants.score.infinite?'<img src="images/mate_'+this.constants.owner.white+'.png" title="White wins" alt="-&#8734;" />':s.valuation==this.constants.owner.white*this.constants.score.infinite?'<img src="images/mate_'+this.constants.owner.black+'.png" title="Black wins" alt="+&#8734;" />':null!==s.valuationPC?s.valuationPC+"%":s.valuation,n+="</td>",n+="<td>",n+=s.valuationSolver==this.constants.owner.black*this.constants.score.infinite?'<img src="images/mate_'+this.constants.owner.white+'.png" title="White wins" alt="-&#8734;" />':s.valuationSolver==this.constants.owner.white*this.constants.score.infinite?'<img src="images/mate_'+this.constants.owner.black+'.png" title="Black wins" alt="+&#8734;" />':null!==s.valuationSolverPC?s.valuationSolverPC+"%":s.valuationSolver,e.nodes[o].hasOwnProperty("_opportunity")&&Math.abs(e.nodes[o].valuationSolver)!=this.constants.score.infinite){switch(n+="<td>",e.nodes[o]._opportunity){case"-":n+='<img src="images/opportunity_0.png" title="Risk of defeat" />';break;case"±":n+='<img src="images/opportunity_1.png" title="Uncertain end of game" />';break;case"+":n+='<img src="images/opportunity_2.png" title="Opportunity of victory" />';break;default:throw"Internal error - Report any error (#016)"}n+="</td>"}else n+="<td></td>";n+="</td></tr>"}return 0===n.length?"":'<table class="ui-table" data-role="table" data-mode="table"><thead><tr class="th-groups"><th></th><th colspan="3">Evaluation</th></tr><tr><th data-priority="1">Move</th><th data-priority="2">Static</th><th data-priority="3">Deep</th><th data-priority="4">&nbsp;</th></tr></thead><tbody>'+n+"</tbody></table>"},AntiCrux.prototype.toHtml=function(t){var e,o,n,s,i,a,r;for(void 0===t&&(t=this._root_node),n=this.options.board.rotated,r="",s=1,i="abcdefgh",o=n?7:0;!n&&o<8||n&&o>=0;n?o--:o++){for(s=1-s,r+='<div class="AntiCrux-board-line">',this.options.board.coordinates&&(r+='<div class="AntiCrux-board-coordinates-vertical">'+(8-o)+"</div>"),e=n?7:0;!n&&e<8||n&&e>=0;n?e--:e++){switch(s=1-s,this.options.variant.pieces){case 1:a=t.owner[8*o+e]!=this.constants.owner.none?this.constants.owner.white:t.owner[8*o+e];break;case 2:a=t.owner[8*o+e]!=this.constants.owner.none?this.constants.owner.black:t.owner[8*o+e];break;case 3:a=this.constants.owner.none;break;case 4:a=t.owner[8*o+e]==this.constants.owner.none?this.constants.owner.none:Math.floor(100*Math.random())%2===0?this.constants.owner.black:this.constants.owner.white;break;default:a=t.owner[8*o+e]}r+='<div class="AntiCrux-board-cell-'+(this._highlight.indexOf(8*o+e)!=-1?"hl":s)+" AntiCrux-board-piece-"+a+t.piece[8*o+e]+'" data-xy="'+i[e]+(8-o)+'">',this.options.board.debugCellId&&(r+=o+"/"+e+"<br/>"+(8*o+e)),r+="</div>"}r+="</div>"}if(this.options.board.coordinates){for(i=i.toUpperCase(),r+='<div class="AntiCrux-board-line">',r+='<div class="AntiCrux-board-coordinates-corner"></div>',e=0;e<i.length;e++)r+='<div class="AntiCrux-board-coordinates-horizontal">'+i[n?7-e:e]+"</div>";r+="</div>"}return'<div class="AntiCrux-board">'+r+"</div>"},AntiCrux.prototype.toFen=function(t){var e,o,n,s;if(void 0===t&&(t=this._root_node),!this._has(t,"piece",!0)||!this._has(t,"owner",!0))return"";for(o="",n=0,e=0;e<64;e++)t.owner[e]==this.constants.owner.none?n++:(n>0&&(o+=n,n=0),s=this.constants.piece.mapping_rev[t.piece[e]],t.owner[e]==this.constants.owner.black&&(s=s.toLowerCase()),o+=s),(e+1)%8===0&&(n>0&&(o+=n,n=0),e<63&&(o+="/"));return o+=t.player==this.constants.owner.black?" b":" w",o+=" -",o+=t.hasOwnProperty("enpassant")&&this.options.variant.enPassant?" "+"abcdefgh"[t.enpassant%8]:" -",o+=" "+this._halfmoveclock,o+=this._has(this,"_history",!0)?" "+Math.ceil(this._history.length/2):" 0"},AntiCrux.prototype.toText=function(t){var e,o,n,s,i,a,r,h;for(void 0===t&&(t=this._root_node),n=this.options.board.rotated,r="",o=n?7:0;!n&&o<8||n&&o>=0;n?o--:o++)for(e=n?7:0;!n&&e<8||n&&e>=0;n?e--:e++){switch(s=8*o+e,i=(e+o)%2==1,e===(n?7:0)&&(r+=this.options.board.coordinates?"àáâãäåæç"[7-o]:"$"),this.options.variant.pieces){case 1:h=t.owner[s]!=this.constants.owner.none?this.constants.owner.white:t.owner[s];break;case 2:h=t.owner[s]!=this.constants.owner.none?this.constants.owner.black:t.owner[s];break;case 3:h=this.constants.owner.none;break;case 4:h=t.owner[s]==this.constants.owner.none?this.constants.owner.none:Math.floor(100*Math.random())%2===0?this.constants.owner.black:this.constants.owner.white;break;default:h=t.owner[s]}switch(h){case this.constants.owner.none:a=i?"+":"*";break;case this.constants.owner.white:a=" prnbqk"[t.piece[s]];break;case this.constants.owner.black:a=" otmvwl"[t.piece[s]];break;default:throw"Internal error - Report any error (#009)"}i&&(a=a.toUpperCase()),r+=a,e===(n?0:7)&&(r+="%\n")}return'A""""""""S\n'+r+(this.options.board.coordinates?n?"DïîíìëêéèF":"DèéêëìíîïF":"D((((((((F")},AntiCrux.prototype.toPgn=function(t){var e,o,n,s,i,a,r,h;if(!this._has(this,"_history",!0)||!this._has(this,"_history_fen0",!0))return"";"object"!=typeof t&&(t={}),e=function(e,o){t.hasOwnProperty(e)||(t[e]=o)},e("Event","Game"),e("Site","https://github.com/ecrucru/anticrux/"),e("Date",(new Date).toISOString().slice(0,10)),this.options.board.rotated?(e("White","AntiCrux "+this.options.ai.version+(null===this._lastLevel?"":" - Level "+this._lastLevel)),e("Black","You")):(e("White","You"),e("Black","AntiCrux "+this.options.ai.version+(null===this._lastLevel?"":" - Level "+this._lastLevel))),e("Termination","normal"),e("Result","*"),this.hasSetUp()&&(e("SetUp","1"),e("FEN",this._history_fen0)),e("PlyCount",this._history.length),e("Variant","antichess"),e("TimeControl","-"),o="";for(i in t)o+="string"==typeof t[i]?"["+i+' "'+t[i].split('"').join("'")+'"]\n':"["+i+' "'+t[i]+'"]\n';if(o+="\n",h=this.options.board.symbols,this.options.board.symbols=!1,n=new AntiCrux,n.copyOptions(this),!n.loadFen(this._history_fen0))return"";for(a=0,s=0;s<this._history.length;s++){if(s%2===0&&(o+=(a>0?" ":"")+ ++a+"."),r=n.moveToString(this._history[s]),n.movePiece(this._history[s],!0,this.constants.owner.none)==n.constants.move.none)throw"Internal error - Report any error (#011)";o+=" "+r,n.switchPlayer()}if("?"!=t.Result)o+="# "+t.Result;else switch(n.getWinner()){case n.constants.owner.white:o+="# 1-0",o=o.replace('[Result "*"]','[Result "1-0"]');break;case n.constants.owner.black:o+="# 0-1",o=o.replace('[Result "*"]','[Result "0-1"]');break;case n.constants.owner.none:n.isDraw()&&(o+="# 1/2-1/2",o=o.replace('[Result "*"]','[Result "1/2-1/2"]'))}return this.options.board.symbols=h,o},AntiCrux.prototype.toConsole=function(t,e){var o,n,s,i,a,r;for(void 0===e&&(e=this._root_node),s=this.options.board.rotated,r="",n=s?7:0;!s&&n<8||s&&n>=0;s?n--:n++){for(o=s?7:0;!s&&o<8||s&&o>=0;s?o--:o++){switch(i=8*n+o,t&&o===(s?7:0)&&(r+=this.options.board.coordinates?" "+"12345678"[7-n]+" |":"|"),a=this.constants.piece.mapping_rev[e.piece[i]],e.owner[i]){case this.constants.owner.white:a=a.toUpperCase();break;case this.constants.owner.black:a=a.toLowerCase();break;case this.constants.owner.none:a=t||e.piece[i]!=this.constants.owner.none?" ":"."}r+=" "+a+(t?" |":""),o===(s?0:7)&&(r+="\n")}t&&(r+=(this.options.board.coordinates?"   ":"")+"+---+---+---+---+---+---+---+---+"),n!=(s?0:7)&&(r+="\n")}return t&&(r=(this.options.board.coordinates?"   ":"")+"+---+---+---+---+---+---+---+---+\n"+r),t&&(r+="\n",this.options.board.coordinates&&(r+=(this.options.board.coordinates?"    ":"")+(s?" H   G   F   E   D   C   B   A  ":" A   B   C   D   E   F   G   H  ")+"\n")),r},AntiCrux.prototype.freeMemory=function(){var t;return this._buffer="",t=this._ai_nodeFreeMemory(this._root_node),this._ai_gc(),t},AntiCrux.prototype.callbackExploration=null,AntiCrux.prototype._init=function(){this.constants={piece:{none:0,pawn:1,rook:2,knight:3,bishop:4,queen:5,king:6},owner:{black:-1,none:0,white:1},score:{infinite:16777217,neutral:0},board:{classicalFischer:519},move:{none:0}},this.constants.piece.mapping={"":this.constants.piece.none,p:this.constants.piece.pawn,P:this.constants.piece.pawn,r:this.constants.piece.rook,R:this.constants.piece.rook,n:this.constants.piece.knight,N:this.constants.piece.knight,b:this.constants.piece.bishop,B:this.constants.piece.bishop,q:this.constants.piece.queen,Q:this.constants.piece.queen,k:this.constants.piece.king,K:this.constants.piece.king},this.constants.piece.mapping_rev=[],this.constants.piece.mapping_rev[this.constants.piece.none]="",this.constants.piece.mapping_rev[this.constants.piece.pawn]="P",this.constants.piece.mapping_rev[this.constants.piece.rook]="R",this.constants.piece.mapping_rev[this.constants.piece.knight]="N",this.constants.piece.mapping_rev[this.constants.piece.bishop]="B",this.constants.piece.mapping_rev[this.constants.piece.queen]="Q",this.constants.piece.mapping_rev[this.constants.piece.king]="K",this.options={ai:{version:"0.2.1",elo:1750,valuation:[],maxDepth:12,maxNodes:1e5,minimizeLiberty:!0,maxReply:1,noStatOnForcedMove:!1,wholeNodes:!0,randomizedSearch:!0,pessimisticScenario:!0,bestStaticScore:!0,opportunistic:!1,handicap:0,acceleratedEndGame:!0,oyster:!1},variant:{enPassant:!0,promoteQueen:!1,activePawns:!1,pieces:0},board:{rotated:!1,symbols:!1,fischer:this.getNewFischerId(),coordinates:!0,noStatOnOwnMove:!0,decisionTree:!1,fullDecisionTree:!1,analysisDepth:5,debugCellId:!1}},this.options.ai.valuation[this.constants.piece.none]=0,this.options.ai.valuation[this.constants.piece.pawn]=100,this.options.ai.valuation[-this.constants.piece.pawn]=180,this.options.ai.valuation[this.constants.piece.rook]=500,this.options.ai.valuation[this.constants.piece.knight]=300,this.options.ai.valuation[this.constants.piece.bishop]=300,this.options.ai.valuation[this.constants.piece.queen]=900,this.options.ai.valuation[this.constants.piece.king]=250},AntiCrux.prototype._has=function(t,e,o){var n=void 0!==t&&null!==t;if(n){if(n=t.hasOwnProperty(e),n&&null===t[e])return!1;void 0===o?n&&(n=t[e]===!0):"string"==typeof o?n&&(n=t[e]==o):n&&o&&(n=t[e].length>0)}return n},AntiCrux.prototype._discoverFischer=function(t){var e,o,n,s;for(void 0===t&&(t=this._root_node),o=null,s=new AntiCrux,n=this.toFen(t).split(" ")[0],e=1;e<=960;e++)if(s.defaultBoard(e),s.toFen().substring(0,n.length)==n){o=e;break}return o},AntiCrux.prototype._ai_nodeCopy=function(t,e){var o={player:t.player,piece:t.piece.slice(0),owner:t.owner.slice(0)};return t.hasOwnProperty("enpassant")&&(o.enpassant=t.enpassant),e&&(t.hasOwnProperty("valuation")&&(o.valuation=t.valuation),t.hasOwnProperty("valuationSolver")&&(o.valuationSolver=t.valuationSolver),t.hasOwnProperty("moves")&&(o.moves=t.moves.slice(0)),t.hasOwnProperty("_pendingPromotion")&&(o._pendingPromotion=t._pendingPromotion)),o},AntiCrux.prototype._ai_nodeShrink=function(t){var e;for(e in t)["owner","piece","player","enpassant","_pendingPromotion"].indexOf(e)===-1&&delete t[e]},AntiCrux.prototype._ai_nodeInventory=function(t,e,o,n){var s,i;for(void 0===n&&(n=this._root_node),i=0,s=0;s<64;s++)if(!(n.owner[s]!=t&&null!==t||n.piece[s]!=e&&null!==e)){if(void 0!==o&&s%8!=o)continue;i++}return i},AntiCrux.prototype._ai_nodeCountPiece=function(t,e){var o,n;for(void 0===e&&(e=this._root_node),n=0,o=0;o<64;o++)n+=e.owner[o]==t?1:0;return n},AntiCrux.prototype._ai_nodeLocatePiece=function(t,e,o){var n,s;for(void 0===o&&(o=this._root_node),s=0;s<8;s++)for(n=0;n<8;n++)if(!(o.owner[8*s+n]!=t&&null!==t||o.piece[8*s+n]!=e&&null!==e))return{x:n,y:s};return null},AntiCrux.prototype._ai_nodeMoves=function(t){var e,o,n,s,i,a,r,h,c,p,l,u,d,v,f=this,_=function(e,s,i,a){var r,h,u,d;return!(s<0||s>7||e<0||e>7)&&(r=t.owner[8*e+s],h=r!=t.player&&r!=f.constants.owner.none,!(r==t.player||h&&!i)&&(h&&!l&&(p=[],l=!0),!h&&(h||l||a)||(d=!1,t.piece[8*n+o]==f.constants.piece.pawn&&(0===e&&t.owner[8*n+o]==f.constants.owner.white||7===e&&t.owner[8*n+o]==f.constants.owner.black)&&(u=c+10*e+s,p.push(u+1e4*f.constants.piece.queen),f.options.variant.promoteQueen||(p.push(u+1e4*f.constants.piece.rook),p.push(u+1e4*f.constants.piece.knight),p.push(u+1e4*f.constants.piece.bishop),p.push(u+1e4*f.constants.piece.king)),d=!0),d||p.push(c+10*e+s)),!h))};if(void 0!==t&&null!==t){for(l=!1,p=[],n=0;n<8;n++)for(o=0;o<8;o++)if(e=8*n+o,t.owner[e]==t.player)switch(c=1e3*n+100*o,t.piece[e]){case this.constants.piece.none:continue;case this.constants.piece.pawn:d=-t.player,_(n+d,o,!1,!1)&&(d==-1&&6==n||1==d&&1==n)&&_(n+2*d,o,!1,!1),_(n+d,o-1,!0,!0),_(n+d,o+1,!0,!0),t.hasOwnProperty("enpassant")&&this.options.variant.enPassant&&(i=t.enpassant%8,a=Math.floor(t.enpassant/8),r=i,h=a-d,i>=0&&i<=7&&a>=0&&a<=7&&r>=0&&r<=7&&h>=0&&h<=7&&1==Math.abs(i-o)&&a-n==d&&t.piece[e]==this.constants.piece.pawn&&t.piece[8*a+i]==this.constants.piece.none&&t.piece[8*h+r]==this.constants.piece.pawn&&t.owner[8*a+i]!=t.owner[8*h+r]&&(l||(p=[]),l=!0,p.push(c+10*a+i)));break;case this.constants.piece.queen:case this.constants.piece.rook:for(u=1;u<8&&_(n,o+u,!0,!1);u++);for(u=1;u<8&&_(n,o-u,!0,!1);u++);for(d=1;d<8&&_(n+d,o,!0,!1);d++);for(d=1;d<8&&_(n-d,o,!0,!1);d++);if(t.piece[e]==this.constants.piece.rook)break;case this.constants.piece.bishop:for(v=1;v<8&&_(n+v,o+v,!0,!1);v++);for(v=1;v<8&&_(n+v,o-v,!0,!1);v++);for(v=1;v<8&&_(n-v,o+v,!0,!1);v++);for(v=1;v<8&&_(n-v,o-v,!0,!1);v++);break;case this.constants.piece.king:for(u=-1;u<=1;u++)for(d=-1;d<=1;d++)0===u&&0===d||_(n+d,o+u,!0,!1);break;case this.constants.piece.knight:_(n-2,o-1,!0,!1),_(n-2,o+1,!0,!1),_(n+2,o-1,!0,!1),_(n+2,o+1,!0,!1),_(n-1,o-2,!0,!1),_(n-1,o+2,!0,!1),_(n+1,o-2,!0,!1),_(n+1,o+2,!0,!1);break;default:throw"Internal error - Report any error (#003)"}if(this.options.ai.randomizedSearch)for(o=p.length-1;o>=0;o--)n=Math.round(Math.random()*o),s=p[n],p[n]=p[o],p[o]=s;t.moves=p}},AntiCrux.prototype._ai_nodeCreateNodes=function(t){var e,o;if(t.hasOwnProperty("moves")&&t.hasOwnProperty("player"))for(t.nodes=[],e=0;e<t.moves.length;e++){if(o=this._ai_nodeCopy(t,!1),this.movePiece(t.moves[e],!1,t.player,o)==this.constants.move.none)throw"Internal error - Report any error (#013)";this.switchPlayer(o),t.nodes.push(o)}},AntiCrux.prototype._ai_nodeRecurseTree=function(t,e,o){var n,s,i;if(void 0!==o&&null!==o){if(this.options.ai.handicap>0&&o.player==t)for(i=o.moves.length>4?Math.floor((o.moves.length-4)*this.options.ai.handicap/100):0,n=i;n>0;n--)s=Math.floor(Math.random()*o.moves.length),o.moves.splice(s,1),o.hasOwnProperty("nodes")&&o.nodes.splice(s,1);for(o.hasOwnProperty("nodes")||this._ai_nodeCreateNodes(o),i=this.constants.score.infinite,n=0;n<o.nodes.length;n++)o.nodes[n].hasOwnProperty("moves")||this._ai_nodeMoves(o.nodes[n]),this.options.ai.minimizeLiberty&&o.nodes[n].player!=t&&o.nodes[n].moves.length>=this.options.ai.maxReply&&o.nodes[n].moves.length<i&&(i=o.nodes[n].moves.length);for(n=o.nodes.length-1;n>=0;n--)o.player==t&&o.nodes[n].moves.length>i?(o.moves.splice(n,1),o.nodes.splice(n,1)):(this._numNodes++,o.nodes[n].hasOwnProperty("valuation")||(o.nodes[n].valuation=this._ai_nodeValuate(o.nodes[n]).valuation),e>=this.options.ai.maxDepth||0!==this.options.ai.maxNodes&&this._numNodes>=this.options.ai.maxNodes||this._ai_nodeRecurseTree(t,e+1,o.nodes[n]))}},AntiCrux.prototype._ai_nodeValuate=function(t){var e,o,n;if(void 0===t&&(t=this._root_node),!this._has(t,"piece",!0)||!this._has(t,"owner",!0))return{black:0,white:0,scale:1,valuation:t.hasOwnProperty("valuation")?t.valuation:"-",valuationPC:null,valuationSolver:t.hasOwnProperty("valuationSolver")?t.valuationSolver:"-",valuationSolverPC:null};for(n={black:0,white:0,scale:0,valuation:0,valuationPC:0,valuationSolver:0,valuationSolverPC:0},e=0;e<64;e++)switch(o=this.options.variant.activePawns&&t.piece[e]==this.constants.piece.pawn&&(t.owner[e]==this.constants.owner.black&&1!=Math.floor(e/8)||t.owner[e]==this.constants.owner.white&&6!=Math.floor(e/8))?this.options.ai.valuation[-t.piece[e]]:this.options.ai.valuation[t.piece[e]],t.owner[e]){case this.constants.owner.black:n.black+=o;break;case this.constants.owner.white:n.white+=o;break;case this.constants.owner.none:break;default:throw"Internal error - Report any error (#014)"}return 0===n.black?n.valuation=this.constants.owner.white*this.constants.score.infinite:0===n.white?n.valuation=this.constants.owner.black*this.constants.score.infinite:n.valuation=this.constants.owner.black*n.black+this.constants.owner.white*n.white,t.hasOwnProperty("moves")&&0===t.moves.length&&(n.valuation=t.player*-this.constants.score.infinite),n.scale=n.black>n.white?n.black:n.white,0===n.scale&&(n.valuation=0,n.scale=1),n.valuationPC=Math.round(100*n.valuation/n.scale),n.scale=Math.round(n.scale),n.valuation=Math.round(n.valuation),n.valuationSolver=t.hasOwnProperty("valuationSolver")?t.valuationSolver:n.valuation,Math.abs(n.valuationSolver)>n.scale&&(n.scale=Math.abs(n.valuationSolver)),n.valuationSolverPC=Math.round(2*(100*(n.valuationSolver+n.scale)/(2*n.scale)-50)),n},AntiCrux.prototype._ai_nodeSolve=function(t,e,o,n){var s,i,a,r,h,c,p,l,u;if(void 0===n&&(n=this._root_node),a=this._has(n,"nodes",!0),this.options.board.decisionTree&&a&&e<=this.options.board.analysisDepth)for(s=0;s<n.nodes.length;s++)n.nodes[s].hasOwnProperty("path")||(n.nodes[s].path=o),n.nodes[s].path.length>0&&(n.nodes[s].path+="¦"),n.nodes[s].path+=this.moveToString(n.moves[s],n);if(!a)return n.valuationSolver=n.valuation,n._forced=!0,n.valuationSolver==t*-this.constants.score.infinite?(n._sequence=1,n._opportunity="+"):n.valuationSolver==t*this.constants.score.infinite&&(n._opportunity="-"),void(e>1&&(delete n.owner,delete n.piece));for(r=!0,h=!1,s=0;s<n.nodes.length;s++)this._ai_nodeSolve(t,e+1,n.nodes[s].path,n.nodes[s]),i=n.nodes[s].hasOwnProperty("_forced"),i&&n.nodes[s]._forced?i&&n.nodes[s]._forced&&(h=!0):r=!1,n.nodes[s].hasOwnProperty("_opportunity")&&(n.hasOwnProperty("_opportunity")||(n._opportunity=n.nodes[s]._opportunity),n._opportunity!=n.nodes[s]._opportunity&&(n._opportunity="±"));if(n.player==t&&h?n._forced=h:n.player!=t&&r&&(n._forced=r),n.player==t&&h){for(p=t*this.constants.score.infinite,s=n.nodes.length-1;s>=0;s--)this._has(n.nodes[s],"_forced")?(t==this.constants.owner.white&&n.nodes[s].valuationSolver<p||t==this.constants.owner.black&&n.nodes[s].valuationSolver>p)&&(p=n.nodes[s].valuationSolver):(n.moves.splice(s,1),n.nodes.splice(s,1));for(s=n.nodes.length-1;s>=0;s--)n.nodes[s].valuationSolver!=p&&(n.moves.splice(s,1),n.nodes.splice(s,1))}if(c=n.player==t||!this.options.ai.pessimisticScenario){for(n.valuationSolver=0,u=0,s=0;s<n.nodes.length;s++)if(Math.abs(n.nodes[s].valuationSolver)!=this.constants.score.infinite)n.valuationSolver+=n.nodes[s].valuationSolver,u++;else if(n.nodes[s].valuationSolver==t*this.constants.score.infinite){u=0;break}0!==u?(n.valuationSolver=Math.round(n.valuationSolver/u),e>1&&(delete n.owner,delete n.piece)):c=!1}if(!c){for(l=t*-this.constants.score.infinite,s=0;s<n.nodes.length;s++)(t==this.constants.owner.white&&n.nodes[s].valuationSolver>l||t==this.constants.owner.black&&n.nodes[s].valuationSolver<l)&&(l=n.nodes[s].valuationSolver);n.valuationSolver=l,e>1&&(delete n.owner,delete n.piece)}if(this.options.ai.acceleratedEndGame&&this._has(n,"_forced")&&n.valuationSolver==t*-this.constants.score.infinite){for(l=this.constants.score.infinite,s=0;s<n.nodes.length;s++)n.nodes[s].hasOwnProperty("_sequence")&&n.nodes[s]._sequence>0&&n.nodes[s]._sequence<l&&(l=n.nodes[s]._sequence);l!=this.constants.score.infinite&&(n._sequence=l+1)}},AntiCrux.prototype._ai_nodePick=function(t,e){var o,n,s,i,a,r,h,c,p,l=function(t){for(a=null,r=null,o=0;o<t.nodes.length;o++)null===a&&(a=t.nodes[o].valuation),null===r&&(r=t.nodes[o].valuationSolver),"boolean"!=typeof a&&a!=t.nodes[o].valuation&&(a=!0),"boolean"!=typeof r&&r!=t.nodes[o].valuationSolver&&(r=!0);"boolean"!=typeof a&&(a=!1),"boolean"!=typeof r&&(r=!1)};if(void 0===e&&(e=this._root_node),this.options.ai.acceleratedEndGame&&this._has(e,"_forced")&&e.valuationSolver==e.player*-this.constants.score.infinite){for(n=this.constants.score.infinite,o=0;o<e.nodes.length;o++)this._has(e.nodes[o],"_forced")&&e.nodes[o]._sequence>0&&e.nodes[o]._sequence<n&&(n=e.nodes[o]._sequence);if(n==this.constants.score.infinite)throw"Internal error - Report any error (#006)";for(o=e.nodes.length-1;o>=0;o--)e.nodes[o]._sequence!=n&&(e.moves.splice(o,1),this._ai_nodeFreeMemory(e.nodes[o]),e.nodes.splice(o,1))}if(l(e),this.options.ai.opportunistic&&e.nodes.length>1){for(s="",o=0;o<e.nodes.length;o++)i=e.nodes[o].hasOwnProperty("_opportunity")?e.nodes[o]._opportunity:" ",(0===s.length||"- ±+".indexOf(i)>"- ±+".indexOf(s))&&(s=i);for(o=e.nodes.length-1;o>=0;o--)(e.nodes[o].hasOwnProperty("_opportunity")?e.nodes[o]._opportunity:" ")!=s&&(e.moves.splice(o,1),this._ai_nodeFreeMemory(e.nodes[o]),e.nodes.splice(o,1))}if(l(e),this.options.ai.bestStaticScore&&!r&&a){for(n=t*this.constants.score.infinite,o=0;o<e.nodes.length;o++)(t==this.constants.owner.white&&e.nodes[o].valuation<n||t==this.constants.owner.black&&e.nodes[o].valuation>n)&&(n=e.nodes[o].valuation);for(o=e.nodes.length-1;o>=0;o--)e.nodes[o].valuation!=n&&(e.moves.splice(o,1),this._ai_nodeFreeMemory(e.nodes[o]),e.nodes.splice(o,1))}for(p=[],n=t*this.constants.score.infinite,o=0;o<e.nodes.length;o++)i=Math.round(e.nodes[o].valuationSolver),h=t==this.constants.owner.white&&i<n||t==this.constants.owner.black&&i>n,c=t==this.constants.owner.white&&i==n||t==this.constants.owner.black&&i==n,h&&(p=[],n=i),(c||h)&&p.push(e.moves[o]);switch(p.length){case 0:throw"Internal error - Report any error (#002)";case 1:return p[0];default:return p[Math.round(Math.random()*(p.length-1))]}},AntiCrux.prototype._ai_nodeTreeHtml=function(t,e){var o,n,s,i,a,r;if(void 0===e&&(e=this._root_node),this.options.board.decisionTree&&this._has(e,"nodes",!0))for(o=this,n=function(t){var e;for(e=0;e<t.nodes.length;e++)if(!t.nodes[e].hasOwnProperty("path"))return!0;return!1},s=function(t){return null===t?"-":t==o.constants.owner.black*o.constants.score.infinite?'<img src="images/mate_'+o.constants.owner.white+'.png" title="White wins" alt="-&#8734;" />':t==o.constants.owner.white*o.constants.score.infinite?'<img src="images/mate_'+o.constants.owner.black+'.png" title="Black wins" alt="+&#8734;" />':t},i=0;i<e.nodes.length;i++)if(e.nodes[i].hasOwnProperty("path")){if(r=this.options.board.fullDecisionTree||0===t||t===this.options.board.analysisDepth||!this._has(e.nodes[i],"nodes",!0)||n(e)){for(this._buffer+='<tr data-depth="'+t+'">',this._buffer+="<td>"+s(e.nodes[i].valuation)+"</td>",this._buffer+="<td>"+s(e.nodes[i].valuationSolver)+"</td>",this._buffer+="<td>"+e.nodes[i].path.split("¦").join("</td><td>")+"</td>",a=t+1;a<this.options.board.analysisDepth;a++)this._buffer+="<td>&nbsp;</td>";this._buffer+="</tr>\n"}e.nodes[i].hasOwnProperty("nodes")&&t+1<this.options.board.analysisDepth&&this._ai_nodeTreeHtml(t+1,e.nodes[i])}},AntiCrux.prototype._ai_nodeFreeMemory=function(t){var e,o;if(null===t)return 0;if(void 0===t&&(t=this._root_node),!t.hasOwnProperty("nodes"))return 1;for(o=0,e=0;e<t.nodes.length;e++)o+=this._ai_nodeFreeMemory(t.nodes[e]);return delete t.nodes,delete t.moves,o},AntiCrux.prototype._ai_gc=function(){"object"==typeof global&&"function"==typeof global.gc&&global.gc()},"undefined"!=typeof module&&module.exports&&(module.exports=AntiCrux);