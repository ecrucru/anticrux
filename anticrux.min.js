/*
	AntiCrux - Artificial intelligence playing AntiChess and AntiChess960 with jQuery Mobile
	Copyright (C) 2016-2017, ecrucru

		https://github.com/ecrucru/anticrux/
		http://ecrucru.free.fr/?page=anticrux

	This program is free software: you can redistribute it and/or modify
	it under the terms of the GNU Affero General Public License as
	published by the Free Software Foundation, either version 3 of the
	License, or (at your option) any later version.

	This program is distributed in the hope that it will be useful,
	but WITHOUT ANY WARRANTY; without even the implied warranty of
	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
	GNU Affero General Public License for more details.

	You should have received a copy of the GNU Affero General Public License
	along with this program. If not, see <http://www.gnu.org/licenses/>.
*/
"use strict";var AntiCrux=function(){this._root_node={piece:[],owner:[]},this._init(),this.clearBoard()};AntiCrux.prototype.startUI=function(){if("undefined"==typeof module||!module.exports)throw"Error - AntiCrux.prototype.openUI() is restricted to NodeJS";var t=require("opn");t("./node_modules/anticrux/index.html")},AntiCrux.prototype.clearBoard=function(t){var e;for(void 0===t&&(t=this._root_node),this._has(t,"piece",!1)||(t.piece=[]),this._has(t,"owner",!1)||(t.owner=[]),this.freeMemory(),t.player=this.constants.owner.white,this._buffer="",this._highlight=[],t._history=[],t._history_fen0="",this.fischer=null,e=0;e<64;e++)t.piece[e]=this.constants.piece.none,t.owner[e]=this.constants.owner.none;t={piece:t.piece,owner:t.owner}},AntiCrux.prototype.defaultBoard=function(t,e){var o,n,i,s,r;if(void 0===t&&(t=this.constants.board.classicalFischer),void 0===e&&(e=this._root_node),this.clearBoard(e),t<1||t>960)return!1;for(this.fischer=t,r=[this.constants.piece.none,this.constants.piece.none,this.constants.piece.none,this.constants.piece.none,this.constants.piece.none,this.constants.piece.none,this.constants.piece.none,this.constants.piece.none],r[Math.floor(.08*(Math.floor(25*(t-1))%100)+1.5)]=this.constants.piece.bishop,r[Math.floor(.08*(Math.floor(25*Math.floor((t-1)/4))%100)+.5)]=this.constants.piece.bishop,n=Math.floor(Math.floor((t-1)/4)/4)/6,i=Math.floor(6*(n-Math.floor(n))+.5),o=0;o<8;o++)if(r[o]==this.constants.piece.none){if(0===i){r[o]=this.constants.piece.queen;break}i--}for(s=["NNRKR","NRNKR","NRKNR","NRKRN","RNNKR","RNKNR","RNKRN","RKNNR","RKNRN","RKRNN"][Math.floor(n)],o=0;o<8;o++)r[o]==this.constants.piece.none&&(r[o]=this.constants.piece.mapping[s.charAt(0)],s=s.substring(1));for(o=0;o<8;o++)e.piece[0+o]=r[o],e.piece[8+o]=this.constants.piece.pawn,e.piece[48+o]=this.constants.piece.pawn,e.piece[56+o]=r[o],e.owner[0+o]=this.constants.owner.black,e.owner[8+o]=this.constants.owner.black,e.owner[48+o]=this.constants.owner.white,e.owner[56+o]=this.constants.owner.white;return e._history_fen0=this.toFen(),!0},AntiCrux.prototype.getNewFischerId=function(){return Math.floor(960*Math.random())+1},AntiCrux.prototype.loadFen=function(t,e){var o,n,i,s,r;if(void 0===e&&(e=this._root_node),0===t.length)return!1;for(this.clearBoard(e),o=t.split(" "),n=0,i=0,s=0;s<o[0].length&&(r=o[0].charAt(s)," "!=r);s++)if("12345678".indexOf(r)!=-1)n+=parseInt(r);else if("/"==r)n=0,i++;else{if("prnbqk".indexOf(r.toLowerCase())==-1)return this.clearBoard(e),!1;e.piece[8*i+n]=this.constants.piece.mapping[r],e.owner[8*i+n]=r==r.toLowerCase()?this.constants.owner.black:this.constants.owner.white,n++}return void 0===o[1]?e.player=this.constants.owner.white:e.player="b"==o[1]?this.constants.owner.black:this.constants.owner.white,void 0!==o[3]&&"-"!==o[3]&&(s="abcdefgh".indexOf(o[3]),s!==-1&&(e.enpassant=8*(e.player==this.constants.owner.white?2:5)+s)),this._ai_nodeValuate(),e._history_fen0=this.toFen(),this.fischer=this._discoverFischer(e),!0},AntiCrux.prototype.loadLichess=function(t,e){var o;return void 0===e&&(e=this._root_node),!(!t.match(/^[a-zA-Z0-9]{8}$/)&&!t.match(/^[a-zA-Z0-9]{12}$/))&&(o=this,$.ajaxSetup({cache:!1}),$.get("https://en.lichess.org/api/game/"+t+"?with_fens=1&with_moves=1",function(t){}).fail(function(t){}).done(function(t){var n,i,s,r,a,h;if(!o._has(t,"variant","antichess"))return!1;for(a={},o._has(t,"initialFen",!0)?o.loadFen(t.initialFen,a):o.defaultBoard(o.constants.board.classicalFischer,a),n=o.toFen(a),s=o._has(t,"color","black")?o.constants.owner.black:o.constants.owner.white,i=t.moves.split(" "),s=s==o.constants.owner.white&&i.length%2==1?o.constants.owner.black:o.constants.owner.white,r=[],h=0;h<i.length;h++){if(!o.movePiece(i[h],!0,s,a))return!1;r.push(a.lastMove),o.highlightMove(a.lastMove),s=s==o.constants.owner.white?o.constants.owner.black:o.constants.owner.white}return e.owner=a.owner,e.piece=a.piece,e.player=s,e._history=r,e._history_fen0=n,o.fischer=o._discoverFischer(e),!0}),!0)},AntiCrux.prototype.hasSetUp=function(t){return void 0===t&&(t=this._root_node),!!this._has(t,"_history_fen0",!0)&&"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR"!=t._history_fen0.substring(0,43)},AntiCrux.prototype.getInitialPosition=function(t){return void 0===t&&(t=this._root_node),this._has(t,"_history_fen0",!0)?t._history_fen0:""},AntiCrux.prototype.getPlayer=function(t){return void 0===t&&(t=this._root_node),void 0===t.player?this.constants.owner.none:t.player},AntiCrux.prototype.setPlayer=function(t,e){void 0===e&&(e=this._root_node),e.player=t},AntiCrux.prototype.getPieceByCoordinate=function(t,e){var o;return void 0===e&&(e=this._root_node),!!t.match(/^[a-h][1-8]$/)&&(o=8*(8-parseInt(t.charAt(1)))+"abcdefgh".indexOf(t.charAt(0)),{owner:e.owner[o],piece:e.piece[o]})},AntiCrux.prototype.movePiece=function(t,e,o,n){var i,s,r,a,h,c,p,l,d,u,_,f,v,w,g;if(t===!0)return!1;if(void 0===n&&(n=this._root_node),this.hasPendingPromotion(n))return!1;if(void 0===o&&(o=this.constants.owner.none),null===n)return!1;if("string"==typeof t){if(i=t.match(/^([RNBQK])?([a-h]([0-9])?)?(x)?([a-h][0-9])(=[RNBQK])?\s?[\!|\+|\#|\-|\/|\=|\?]*$/),null===i)return!1;for(h=0;h<i.length;h++)void 0===i[h]&&(i[h]="");for(_=i[6].length>1?this.constants.piece.mapping[i[6].substring(1)]:0,g="abcdefgh".indexOf(i[5].charAt(0)),w=8-parseInt(i[5].charAt(1)),r=this._ai_nodeCopy(n,!1),a=[],o==this.constants.owner.none?(r.player=this.constants.owner.black,this._ai_nodeMoves(r),a=a.concat(r.moves),r.player=this.constants.owner.white,this._ai_nodeMoves(r),r.moves=a.concat(r.moves)):(r.player=o,this._ai_nodeMoves(r)),a=[],h=0;h<r.moves.length;h++)if(r.moves[h]%100==10*w+g){if(c=Math.floor(r.moves[h]/100)%10,p=Math.floor(r.moves[h]/1e3)%10,_!=this.constants.piece.none&&Math.floor(r.moves[h]/1e4)%10!=_)continue;if(o!=this.constants.owner.none&&r.owner[8*p+c]!=o)continue;if(1==i[2].length&&i[2]!="abcdefgh".charAt(c))continue;if(2==i[2].length&&(i[2][0]!="abcdefgh".charAt(c)||8-parseInt(i[2][1])!=p))continue;if(1==i[1].length&&this.constants.piece.mapping[i[1]]!=r.piece[8*p+c])continue;if(0===i[1].length&&2!=i[2].length&&r.piece[8*p+c]!=this.constants.piece.pawn)continue;a.indexOf(r.moves[h]%1e4)==-1&&a.push(r.moves[h]%1e4)}if(1!=a.length)return!1;f=Math.floor(a[0]/1e3)%10,v=Math.floor(a[0]/100)%10}else{if(t=parseInt(t),0===t)return!1;_=Math.floor(t/1e4)%10,f=Math.floor(t/1e3)%10,v=Math.floor(t/100)%10,w=Math.floor(t/10)%10,g=t%10}if(v<0||v>7||f<0||f>7||g<0||g>7||w<0||w>7||_>this.constants.piece.king)return!1;if(t=1e4*_+1e3*f+100*v+10*w+g,s=n.owner[8*f+v],s==this.constants.owner.none)return!1;if(n.player=s,n.lastMove=t,e){for(r=this._ai_nodeCopy(n,!1),r.player=s,this._ai_nodeMoves(r),u=!1,h=0;h<r.moves.length;h++)if(t==r.moves[h]||t==r.moves[h]%1e4){u=!0;break}if(!u)return this._highlight=[],!1}return this._has(n,"enpassant",!1)&&8*w+g==n.enpassant&&n.piece[8*f+v]==this.constants.piece.pawn&&n.piece[8*w+g]==this.constants.piece.none?(l=g,d=w+n.player,l>=0&&l<=7&&d>=0&&d<=7&&n.piece[8*d+l]==this.constants.piece.pawn&&n.owner[8*d+l]!=n.owner[8*f+v]&&(n.piece[8*d+l]=this.constants.piece.none,n.owner[8*d+l]=this.constants.owner.none,n.enpassant=null)):n.piece[8*f+v]==this.constants.piece.pawn&&2==Math.abs(w-f)?n.enpassant=4*(w+f)+g:this._has(n,"enpassant",!1)&&(n.enpassant=null),n.piece[8*w+g]=n.piece[8*f+v],n.piece[8*f+v]=this.constants.piece.none,n.owner[8*w+g]=n.owner[8*f+v],n.owner[8*f+v]=this.constants.owner.none,0!==w&&7!==w||n.piece[8*w+g]==this.constants.piece.pawn&&(this.options.variant.promoteQueen&&(_=this.constants.piece.queen),_!=this.constants.piece.none?n.piece[8*w+g]=_:n._pendingPromotion=8*w+g),this._highlight=[],!0},AntiCrux.prototype.getMoveAI=function(t,e){var o,n,i,s,r,a,h,c,p,l,d,u;if(void 0===e&&(e=this._root_node),void 0===t&&(t=this.getPlayer(e)),t!=this.constants.owner.black&&t!=this.constants.owner.white)return null;if(this._buffer="",this.hasPendingPromotion(e))return null;if(this.options.ai.maxDepth<3&&(this.options.ai.maxDepth=3),this._ai_nodeFreeMemory(e),e.player=t,n=this.options.ai.maxDepth,this._ai_nodeMoves(e),0===e.moves.length)return null;if(this.options.ai.oyster)return this._numNodes=0,this._reachedDepth=0,e.moves[Math.floor(Math.random()*(e.moves.length-1)+.5)];for(s=[],r=[],i=3;i<=n;i++){if(this._numNodes=0,this.options.ai.maxDepth=i,this._ai_nodeRecurseTree(t,0,e),this._reachedDepth=i,0===this._numNodes)throw"Internal error - Report any error (#001)";for(s.push(i),r.push(this._numNodes),a=0,h=0,o=0;o<s.length;o++)a+=s[o];for(a/=s.length,o=0;o<r.length;o++)h+=Math.log(r[o]);for(h/=r.length,c=0,o=0;o<s.length;o++)c+=Math.pow(s[o]-a,2);for(c/=s.length,p=0,o=0;o<r.length;o++)p+=(s[o]-a)*(Math.log(r[o])-h);if(p/=r.length,d=0===c?0:p/c,l=Math.exp(h-d*a),u=Math.floor(l*Math.exp(d*(i+1))),i>=n||!this.options.ai.wholeNodes&&0!==this.options.ai.maxNodes&&u>this.options.ai.maxNodes||this.options.ai.wholeNodes&&0!==this.options.ai.maxNodes&&this._numNodes>=this.options.ai.maxNodes)break}return this.options.ai.maxDepth=n,this._ai_nodeSolve(t,e),this._ai_nodePick(t,e)},AntiCrux.prototype.predictMoves=function(t){var e,o,n,i;if(void 0===t&&(t=this._root_node),this.hasPendingPromotion(t))return"Error : the position is waiting for a promotion.";if(this._ai_nodeFreeMemory(t),e=new AntiCrux,e.options.ai.maxDepth=3,e.options.ai.maxNodes=0,e.options.ai.wholeNodes=!0,e.options.board.symbols=this.options.board.symbols,!e.loadFen(this.toFen(t)))return"Error : the position cannot be loaded.";if(e._ai_nodeMoves(e._root_node),0===e._root_node.moves.length)return"The game is over.";for(i="",n=0;n<5;n++){if(o=e.getMoveAI(),null===o){e.freeMemory();break}if(i.length>0&&(i+=" "),i+=e.moveToString(o),e.freeMemory(),!e.movePiece(o,!0))throw"Internal error - Report any error (#012)";e.switchPlayer()}return"The predicted moves are :\n"+i+"\n\nScore = "+e.getScore()+"%"},AntiCrux.prototype.logMove=function(t,e){if(void 0===e&&(e=this._root_node),void 0===t){if(!this._has(e,"lastMove",!1))return!1;t=e.lastMove}return"number"==typeof t&&(e._history.push(t),!0)},AntiCrux.prototype.undoMove=function(t){var e,o;if(void 0===t&&(t=this._root_node),!this._has(t,"_history",!0)||!this._has(t,"_history_fen0",!0))return"";for(o=t._history.slice(0,t._history.length-1),this.loadFen(t._history_fen0,t),e=0;e<o.length;e++){if(!this.movePiece(o[e],!0,this.constants.owner.none,t))throw"Internal error - Report any error (#004)";this.switchPlayer(t)}return t._history=o,!0},AntiCrux.prototype.getNumNodes=function(){return void 0===this._numNodes?0:this._numNodes},AntiCrux.prototype.getReachedDepth=function(){return void 0===this._reachedDepth?0:this._reachedDepth},AntiCrux.prototype.hasPendingPromotion=function(t){return void 0===t&&(t=this._root_node),this._has(t,"_pendingPromotion",!1)},AntiCrux.prototype.promote=function(t,e){return void 0===e&&(e=this._root_node),!!this.hasPendingPromotion(e)&&("string"==typeof t&&(t=this.constants.piece.mapping[t]),e.piece[e._pendingPromotion]=this.options.variant.promoteQueen?this.options.piece.queen:t,e.lastMove=1e4*(this.options.variant.promoteQueen?this.options.piece.queen:t)+e.lastMove%1e4,void(e._pendingPromotion=null))},AntiCrux.prototype.getPieceSymbol=function(t,e,o){var n;if(o){if(e==this.constants.owner.white)switch(t){case this.constants.piece.pawn:n="&#9817;";break;case this.constants.piece.rook:n="&#9814;";break;case this.constants.piece.knight:n="&#9816;";break;case this.constants.piece.bishop:n="&#9815;";break;case this.constants.piece.queen:n="&#9813;";break;case this.constants.piece.king:n="&#9812;";break;default:n=""}else switch(t){case this.constants.piece.pawn:n="&#9823;";break;case this.constants.piece.rook:n="&#9820;";break;case this.constants.piece.knight:n="&#9822;";break;case this.constants.piece.bishop:n="&#9821;";break;case this.constants.piece.queen:n="&#9819;";break;case this.constants.piece.king:n="&#9818;";break;default:n=""}return 0===n.length?"":'<span class="AntiCrux-big">'+n+"</span>"}return t==this.constants.piece.pawn?"":this.constants.piece.mapping_rev[t].toUpperCase()},AntiCrux.prototype.moveToString=function(t,e){var o,n,i,s,r,a,h,c,p;return void 0===e&&(e=this._root_node),null===t?"":(o=parseInt(t),n=Math.floor(o/1e4)%10,i=Math.floor(o/1e3)%10,s=Math.floor(o/100)%10,r=Math.floor(o/10)%10,a=o%10,p=this.getPieceSymbol(e.piece[8*i+s],e.owner[8*i+s],this.options.board.symbols),c=e.owner[8*r+a]!=e.owner[8*i+s]&&e.owner[8*r+a]!=this.constants.owner.none,this._has(e,"enpassant",!1)&&(c=c||e.piece[8*i+s]==this.constants.piece.pawn&&8*r+a==e.enpassant),this._ai_nodeInventory(e.owner[8*i+s],e.piece[8*i+s],void 0,e)>1||c&&e.piece[8*i+s]==this.constants.piece.pawn?(h="abcdefgh".charAt(s),this._ai_nodeInventory(e.owner[8*i+s],e.piece[8*i+s],s,e)>1&&(h+=8-i)):h="",c||e.piece[8*i+s]!=this.constants.piece.pawn||s!=a||(h=""),c||1!=this._ai_nodeInventory(e.owner[8*i+s],e.piece[8*i+s],void 0,e)||(h=""),c&&(h+="x"),p+=h,p+="abcdefgh".charAt(a),p+=8-r,n!=this.constants.piece.none&&(p+="="+this.getPieceSymbol(n,e.owner[8*i+s],this.options.board.symbols)),p)},AntiCrux.prototype.getScore=function(t){var e,o,n,i,s;for(void 0===t&&(t=this._root_node),i=0,s=0,e=0;e<64;e++)switch(o=this.options.ai.valuation[t.piece[e]],t.owner[e]){case this.constants.owner.black:s+=o;break;case this.constants.owner.white:i+=o}return n=s>i?s:i,0===n?0:(this._has(t,"valuationSolver",!1)?o=t.valuationSolver:(this._has(t,"valuation",!1)||this._ai_nodeValuate(t),o=t.valuation),o=2*(Math.round(100*(o+n)/(2*n))-50),o<-100&&(o=-100),o>100&&(o=100),o)},AntiCrux.prototype.switchPlayer=function(t){void 0===t&&(t=this._root_node),t.player==this.constants.owner.white?t.player=this.constants.owner.black:t.player=this.constants.owner.white},AntiCrux.prototype.getWinner=function(t){var e=this._ai_nodeCopy(void 0===t?this._root_node:t,!0);return e.player=this.constants.owner.white,this._ai_nodeMoves(e),this._has(e,"moves",!0)?(e.player=this.constants.owner.black,this._ai_nodeMoves(e),this._has(e,"moves",!0)?this.constants.owner.none:this.constants.owner.black):this.constants.owner.white},AntiCrux.prototype.isDraw=function(t){return void 0===t&&(t=this._root_node),!!(this._has(this,"_reachedDepth",!1)&&this._has(t,"valuation",!1)&&this._has(t,"valuationSolver",!1))&&(this._reachedDepth>=5&&0===t.valuation&&0===t.valuationSolver&&this._ai_nodeInventory(this.constants.owner.black,null,void 0,t)<=5&&this._ai_nodeInventory(this.constants.owner.white,null,void 0,t)<=5)},AntiCrux.prototype.isEndGame=function(t){var e=this._ai_nodeCopy(void 0===t?this._root_node:t,!1);return this.switchPlayer(e),this._ai_nodeMoves(e),!this._has(e,"moves",!0)},AntiCrux.prototype.highlight=function(t,e){if(void 0===e&&(e=null),(t||null===e)&&(this._highlight=[]),null===e);else if(Array.isArray(e))this._highlight=this._highlight.concat(e);else if("string"!=typeof e)this._highlight.push(parseInt(e));else if(0===e.length);else if(e.match(/^[a-h][1-8]$/))this._highlight.push(8*(8-parseInt(e.charAt(1)))+"abcdefgh".indexOf(e.charAt(0)));else{if(!e.match(/^[0-7]{2}$/))return!1;this._highlight.push(parseInt(e))}return!0},AntiCrux.prototype.highlightMove=function(t){var e,o,n,i;0===t?this._highlight=[]:(e=Math.floor(t/1e3)%10,o=Math.floor(t/100)%10,n=Math.floor(t/10)%10,i=t%10,this._highlight=[8*e+o,8*n+i])},AntiCrux.prototype.highlightMoves=function(t){var e,o,n;for(this._highlight=[],t?(e=this._ai_nodeCopy(this._root_node,!1),this._ai_nodeMoves(e)):e=this._root_node,o=0;o<e.moves.length;o++)0!==e.moves[o]&&(this._has(e,"nodes",!0)&&null===e.nodes[o]||(n=e.moves[o]%100,this._highlight.push(8*Math.floor(n/10)+n%10)))},AntiCrux.prototype.getHistory=function(t){return void 0===t&&(t=this._root_node),this._has(t,"_history",!1)?t._history:[]},AntiCrux.prototype.getHistoryHtml=function(t){var e,o,n;if(void 0===t&&(t=this._root_node),!this._has(t,"_history",!1)||!this._has(t,"_history_fen0",!1))return"";if(0===t._history.length||0===t._history_fen0.length)return"";for(e={},this.loadFen(t._history_fen0,e),n='<table class="ui-table AntiCrux-table" data-role="table">',o=0;o<t._history.length;o++){if(o%2===0&&(n+="<tr><th>"+Math.floor((o+2)/2)+"</th>"),n+='<td class="AntiCrux-history-item" data-index="'+o+'" title="Click to review this past move">'+this.moveToString(t._history[o],e)+"</td>",!this.movePiece(t._history[o],!0,this.constants.owner.none,e))throw"Internal error - Report any error (#010)";o%2==1&&(n+="</tr>")}return o%2==1&&(n+="</tr>"),n+"</table>"},AntiCrux.prototype.getDecisionTreeHtml=function(t){return void 0===t&&(t=this._root_node),this._buffer="",this._ai_nodeTreeHtml(0,"",t),0===this._buffer.length&&(this._buffer='<tr><td colspan="7">No data</td></tr>'),'<table class="ui-table AntiCrux-table" data-role="table">\t<thead>\t\t<tr>\t\t\t<th>Static</th>\t\t\t<th>Deep</th>\t\t\t<th colspan="5">Moves</th>\t\t</tr>\t</thead>\t<tbody>'+this._buffer+"\t</tbody></table>"},AntiCrux.prototype.getMovesHtml=function(t,e){var o,n,i,s;if(n=void 0===e?this._root_node:e,this._has(n,"nodes",!1)&&this._has(n,"moves",!1)||(n=this._ai_nodeCopy(n,!1),n.player=t,this._ai_nodeMoves(n)),s="",this._has(n,"nodes",!0)&&this._has(n,"moves",!0))for(i=this._ai_getMaxValuation(n),0===i&&(i=1),o=0;o<n.moves.length;o++)null!==n.nodes[o]&&(s+="<tr><td>"+this.moveToString(n.moves[o],n)+"</td>",n.nodes[o].hasOwnProperty("valuation")?(n.nodes[o].hasOwnProperty("valuationSolver")?(s+="<td>"+this._ai_formatScore(100*n.nodes[o].valuationSolver/i,!0),this._has(n.nodes[o],"_win",!1)&&Math.abs(n.nodes[o].valuationSolver)!=this.constants.score.infinite&&(s+=' <span title="Opportunity of victory">*</span>'),s+="</td>"):s+="<td></td>",s+="<td>"+this._ai_formatScore(100*n.nodes[o].valuation/i,!0)+"</td>"):s+="<td></td><td></td>",s+="</tr>");return 0===s.length?"":'<table class="ui-table" data-role="table" data-mode="table"><thead><tr class="th-groups"><th></th><th colspan="2">Evaluation</th></tr><tr><th data-priority="1">Move</th><th data-priority="2">Deep</th><th data-priority="3">Static</th></tr></thead><tbody>'+s+"</tbody></table>"},AntiCrux.prototype.toHtml=function(t){var e,o,n,i,s,r;for(void 0===t&&(t=this._root_node),n=this.options.board.rotated,r="",i=1,s="abcdefgh",o=n?7:0;!n&&o<8||n&&o>=0;n?o--:o++){for(i=1-i,r+='<div class="AntiCrux-board-line">',this.options.board.coordinates&&(r+='<div class="AntiCrux-board-coordinates-vertical">'+(8-o)+"</div>"),e=n?7:0;!n&&e<8||n&&e>=0;n?e--:e++)i=1-i,r+='<div class="AntiCrux-board-cell-'+(this._highlight.indexOf(8*o+e)!=-1?"hl":i)+" AntiCrux-board-piece-"+(this.options.variant.whiteBoard&&t.owner[8*o+e]!=this.constants.owner.none?this.constants.owner.white:t.owner[8*o+e])+t.piece[8*o+e]+'" data-xy="'+s[e]+(8-o)+'">',this.options.board.debugCellId&&(r+=o+"/"+e+"<br/>"+(8*o+e)),r+="</div>";r+="</div>"}if(this.options.board.coordinates){for(s=s.toUpperCase(),r+='<div class="AntiCrux-board-line">',r+='<div class="AntiCrux-board-coordinates-corner"></div>',e=0;e<s.length;e++)r+='<div class="AntiCrux-board-coordinates-horizontal">'+s[n?7-e:e]+"</div>";r+="</div>"}return'<div class="AntiCrux-board">'+r+"</div>"},AntiCrux.prototype.toFen=function(t){var e,o,n,i;if(void 0===t&&(t=this._root_node),!this._has(t,"piece",!0)||!this._has(t,"owner",!0))return"";for(o="",n=0,e=0;e<64;e++)t.owner[e]==this.constants.owner.none?n++:(n>0&&(o+=n,n=0),i=this.constants.piece.mapping_rev[t.piece[e]],t.owner[e]==this.constants.owner.black&&(i=i.toLowerCase()),o+=i),(e+1)%8===0&&(n>0&&(o+=n,n=0),e<63&&(o+="/"));return o+=t.player==this.constants.owner.black?" b":" w",o+=" -",o+=this._has(t,"enpassant",!1)?" "+"abcdefgh"[t.enpassant%8]:" -",o+=" 0",o+=this._has(t,"_history",!0)?" "+Math.ceil(t._history.length/2):" 0"},AntiCrux.prototype.toText=function(t){var e,o,n,i,s,r,a;for(void 0===t&&(t=this._root_node),n=this.options.board.rotated,a="",o=n?7:0;!n&&o<8||n&&o>=0;n?o--:o++)for(e=n?7:0;!n&&e<8||n&&e>=0;n?e--:e++){switch(i=8*o+e,s=(e+o)%2==1,e===(n?7:0)&&(a+=this.options.board.coordinates?"àáâãäåæç"[7-o]:"$"),this.options.variant.whiteBoard&&t.owner[i]!=this.constants.owner.none?this.constants.owner.white:t.owner[i]){case this.constants.owner.none:r=s?"+":"*";break;case this.constants.owner.white:r=" prnbqk"[t.piece[i]];break;case this.constants.owner.black:r=" otmvwl"[t.piece[i]];break;default:throw"Internal error - Report any error (#009)"}s&&(r=r.toUpperCase()),a+=r,e===(n?0:7)&&(a+="%\n")}return'A""""""""S\n'+a+(this.options.board.coordinates?n?"DïîíìëêéèF":"DèéêëìíîïF":"D((((((((F")},AntiCrux.prototype.toPgn=function(t){var e,o,n,i,s,r,a;if(void 0===t&&(t=this._root_node),!this._has(t,"_history",!0)||!this._has(t,"_history_fen0",!0))return"";for(e='[Event "Game"]\n',e+='[Site "https://github.com/ecrucru/anticrux/"]\n',e+='[Date "'+(new Date).toISOString().slice(0,10)+'"]\n',e+=this.options.board.rotated?'[White "AntiCrux '+this.options.ai.version+'"]\n[Black "You"]\n':'[White "You"]\n[Black "AntiCrux '+this.options.ai.version+'"]\n',e+='[Result "?"]\n',this.hasSetUp(t)&&(e+='[SetUp "1"]\n',e+='[FEN "'+t._history_fen0+'"]\n'),e+='[PlyCount "'+t._history.length+'"]\n',e+='[Variant "Antichess"]\n',e+='[TimeControl "-"]\n\n',a=this.options.board.symbols,this.options.board.symbols=!1,i=t._history_fen0,s=t._history.slice(0),this.loadFen(t._history_fen0,t),t._history=s,t._history_fen0=i,n=0,o=0;o<t._history.length;o++){if(o%2===0&&(e+=(n>0?" ":"")+ ++n+"."),r=this.moveToString(t._history[o],t),!this.movePiece(t._history[o],!0,this.constants.owner.none,t))throw"Internal error - Report any error (#011)";e+=" "+r,this.switchPlayer(t)}switch(this.getWinner(t)){case this.constants.owner.white:e+="# 1-0",e=e.replace('[Result "?"]','[Result "1-0"]');break;case this.constants.owner.black:e+="# 0-1",e=e.replace('[Result "?"]','[Result "0-1"]')}return this.options.board.symbols=a,e},AntiCrux.prototype.toConsole=function(t,e){var o,n,i,s,r,a;for(void 0===e&&(e=this._root_node),i=this.options.board.rotated,a="",n=i?7:0;!i&&n<8||i&&n>=0;i?n--:n++){for(o=i?7:0;!i&&o<8||i&&o>=0;i?o--:o++){switch(s=8*n+o,t&&o===(i?7:0)&&(a+=this.options.board.coordinates?" "+"12345678"[7-n]+" |":"|"),r=this.constants.piece.mapping_rev[e.piece[s]],e.owner[s]){case this.constants.owner.white:r=r.toUpperCase();break;case this.constants.owner.black:r=r.toLowerCase();break;case this.constants.owner.none:r=t||e.piece[s]!=this.constants.owner.none?" ":"."}a+=" "+r+(t?" |":""),o===(i?0:7)&&(a+="\n")}t&&(a+=(this.options.board.coordinates?"   ":"")+"+---+---+---+---+---+---+---+---+"),n!=(i?0:7)&&(a+="\n")}return t&&(a=(this.options.board.coordinates?"   ":"")+"+---+---+---+---+---+---+---+---+\n"+a),t&&(a+="\n",this.options.board.coordinates&&(a+=(this.options.board.coordinates?"    ":"")+(i?" H   G   F   E   D   C   B   A  ":" A   B   C   D   E   F   G   H  ")+"\n")),a},AntiCrux.prototype.freeMemory=function(){this._ai_nodeFreeMemory(this._root_node)},AntiCrux.prototype._init=function(){this.constants={piece:{none:0,pawn:1,rook:2,knight:3,bishop:4,queen:5,king:6},owner:{black:-1,none:0,white:1},score:{infinite:16777217,neutral:0},board:{classicalFischer:519}},this.constants.piece.mapping={"":this.constants.piece.none,p:this.constants.piece.pawn,P:this.constants.piece.pawn,r:this.constants.piece.rook,R:this.constants.piece.rook,n:this.constants.piece.knight,N:this.constants.piece.knight,b:this.constants.piece.bishop,B:this.constants.piece.bishop,q:this.constants.piece.queen,Q:this.constants.piece.queen,k:this.constants.piece.king,K:this.constants.piece.king},this.constants.piece.mapping_rev=[],this.constants.piece.mapping_rev[this.constants.piece.none]="",this.constants.piece.mapping_rev[this.constants.piece.pawn]="P",this.constants.piece.mapping_rev[this.constants.piece.rook]="R",this.constants.piece.mapping_rev[this.constants.piece.knight]="N",this.constants.piece.mapping_rev[this.constants.piece.bishop]="B",this.constants.piece.mapping_rev[this.constants.piece.queen]="Q",this.constants.piece.mapping_rev[this.constants.piece.king]="K",this.options={ai:{version:"0.1.1",valuation:[],maxDepth:12,maxNodes:1e5,minimizeLiberty:!0,noStatOnForcedMove:!1,wholeNodes:!0,randomizedSearch:!0,pessimisticScenario:!0,bestStaticScore:!0,opportunistic:!1,handicap:0,acceleratedEndGame:!0,oyster:!1},variant:{promoteQueen:!1,activePawns:!0,whiteBoard:!1},board:{rotated:!1,symbols:!1,fischer:this.getNewFischerId(),coordinates:!0,noStatOnOwnMove:!0,fullDecisionTree:!1,debugCellId:!1}},this.options.ai.valuation[this.constants.piece.none]=0,this.options.ai.valuation[this.constants.piece.pawn]=100,this.options.ai.valuation[-this.constants.piece.pawn]=180,this.options.ai.valuation[this.constants.piece.rook]=500,this.options.ai.valuation[this.constants.piece.knight]=300,this.options.ai.valuation[this.constants.piece.bishop]=300,this.options.ai.valuation[this.constants.piece.queen]=900,this.options.ai.valuation[this.constants.piece.king]=250},AntiCrux.prototype._has=function(t,e,o){var n=void 0!==t&&null!==t;if(n){if(n=t.hasOwnProperty(e),n&&null===t[e])return!1;"string"==typeof o?n&&(n=t[e]==o):n&&o&&(n=t[e].length>0)}return n},AntiCrux.prototype._discoverFischer=function(t){var e,o,n,i;if(void 0===t&&(t=this._root_node),!this._has(t,"_history_fen0",!0))return null;for(o=null,i=new AntiCrux,n=this.toFen(t).split(" ")[0],e=1;e<=960;e++)if(i.defaultBoard(e),i.toFen().substring(0,n.length)==n){o=e;break}return o},AntiCrux.prototype._ai_nodeCopy=function(t,e){var o={player:t.player,piece:t.piece.slice(0),owner:t.owner.slice(0)};return this._has(t,"enpassant",!1)&&(o.enpassant=t.enpassant),e&&(this._has(t,"valuation",!1)&&(o.valuation=t.valuation),this._has(t,"valuationSolver",!1)&&(o.valuationSolver=t.valuationSolver),this._has(t,"moves",!1)&&(o.moves=t.moves.slice(0)),this._has(t,"_pendingPromotion",!1)&&(o._pendingPromotion=t._pendingPromotion)),o},AntiCrux.prototype._ai_nodeInventory=function(t,e,o,n){var i,s;for(void 0===n&&(n=this._root_node),s=0,i=0;i<64;i++)if(!(n.owner[i]!=t&&null!==t||n.piece[i]!=e&&null!==e)){if(void 0!==o&&i%8!=o)continue;s++}return s},AntiCrux.prototype._ai_nodeLocatePiece=function(t,e,o){var n,i;for(void 0===o&&(o=this._root_node),i=0;i<8;i++)for(n=0;n<8;n++)if(!(o.owner[8*i+n]!=t&&null!==t||o.piece[8*i+n]!=e&&null!==e))return{x:n,y:i};return null},AntiCrux.prototype._ai_nodeMoves=function(t){var e,o,n,i,s,r,a,h,c,p,l,d,u,_,f=this,v=function(e,i,s,r){var a,h,d,u;return!(i<0||i>7||e<0||e>7)&&(a=t.owner[8*e+i],h=a!=t.player&&a!=f.constants.owner.none,!(a==t.player||h&&!s)&&(h&&!l&&(p=[],l=!0),!h&&(h||l||r)||(u=!1,t.piece[8*n+o]==f.constants.piece.pawn&&(0===e&&t.owner[8*n+o]==f.constants.owner.white||7===e&&t.owner[8*n+o]==f.constants.owner.black)&&(d=c+10*e+i,p.push(d+1e4*f.constants.piece.queen),f.options.variant.promoteQueen||(p.push(d+1e4*f.constants.piece.rook),p.push(d+1e4*f.constants.piece.knight),p.push(d+1e4*f.constants.piece.bishop),p.push(d+1e4*f.constants.piece.king)),u=!0),u||p.push(c+10*e+i)),!h))};if(void 0!==t&&null!==t){for(l=!1,p=[],n=0;n<8;n++)for(o=0;o<8;o++)if(e=8*n+o,t.owner[e]==t.player)switch(c=1e3*n+100*o,t.piece[e]){case this.constants.piece.none:continue;case this.constants.piece.pawn:u=-t.player,v(n+u,o,!1,!1)&&(u==-1&&6==n||1==u&&1==n)&&v(n+2*u,o,!1,!1),v(n+u,o-1,!0,!0),v(n+u,o+1,!0,!0),this._has(t,"enpassant",!1)&&(s=t.enpassant%8,r=Math.floor(t.enpassant/8),a=s,h=r-u,s>=0&&s<=7&&r>=0&&r<=7&&a>=0&&a<=7&&h>=0&&h<=7&&1==Math.abs(s-o)&&r-n==u&&t.piece[e]==this.constants.piece.pawn&&t.piece[8*r+s]==this.constants.piece.none&&t.piece[8*h+a]==this.constants.piece.pawn&&t.owner[8*r+s]!=t.owner[8*h+a]&&(l||(p=[]),l=!0,p.push(c+10*r+s)));break;case this.constants.piece.queen:case this.constants.piece.rook:for(d=1;d<8&&v(n,o+d,!0,!1);d++);for(d=1;d<8&&v(n,o-d,!0,!1);d++);for(u=1;u<8&&v(n+u,o,!0,!1);u++);for(u=1;u<8&&v(n-u,o,!0,!1);u++);if(t.piece[e]==this.constants.piece.rook)break;case this.constants.piece.bishop:for(_=1;_<8&&v(n+_,o+_,!0,!1);_++);for(_=1;_<8&&v(n+_,o-_,!0,!1);_++);for(_=1;_<8&&v(n-_,o+_,!0,!1);_++);for(_=1;_<8&&v(n-_,o-_,!0,!1);_++);break;case this.constants.piece.king:for(d=-1;d<=1;d++)for(u=-1;u<=1;u++)0===d&&0===u||v(n+u,o+d,!0,!1);break;case this.constants.piece.knight:v(n-2,o-1,!0,!1),v(n-2,o+1,!0,!1),v(n+2,o-1,!0,!1),v(n+2,o+1,!0,!1),v(n-1,o-2,!0,!1),v(n-1,o+2,!0,!1),v(n+1,o-2,!0,!1),v(n+1,o+2,!0,!1);break;default:throw"Internal error - Report any error (#003)"}if(this.options.ai.randomizedSearch)for(o=p.length-1;o>=0;o--)n=Math.floor(Math.random()*o+.5),i=p[n],p[n]=p[o],p[o]=i;t.moves=p}},AntiCrux.prototype._ai_nodeCreateNodes=function(t){var e,o;if(t.hasOwnProperty("moves"))for(t.nodes=[],e=0;e<t.moves.length;e++)0!==t.moves[e]&&(o=this._ai_nodeCopy(t,!1),this.movePiece(t.moves[e],!1,t.player,o),o.player==this.constants.owner.white?o.player=this.constants.owner.black:o.player=this.constants.owner.white,t.nodes.push(o))},AntiCrux.prototype._ai_nodeRecurseTree=function(t,e,o){var n,i,s;if(void 0!==o&&null!==o){if(this._has(o,"moves",!0)||this._ai_nodeMoves(o),this.options.ai.handicap>0&&o.player==t)for(i=o.moves.length>4?Math.floor((o.moves.length-4)*this.options.ai.handicap/100):0,n=i;n>0;n--)o.moves.splice(Math.floor(Math.random()*o.moves.length),1);for(this._has(o,"nodes",!0)&&o.nodes.length==o.moves.length||this._ai_nodeCreateNodes(o),i=this.constants.score.infinite,n=0;n<o.nodes.length;n++)this._ai_nodeMoves(o.nodes[n]),this.options.ai.minimizeLiberty&&o.nodes[n].player!=t&&o.nodes[n].moves.length>0&&o.nodes[n].moves.length<i&&(i=o.nodes[n].moves.length);for(s=!1,n=0;n<o.nodes.length;n++)o.player==t&&o.nodes[n].moves.length>i?(o.moves[n]=0,o.nodes[n]=null,s=!0):(this._numNodes++,this._ai_nodeValuate(o.nodes[n]),e>=this.options.ai.maxDepth||0!==this.options.ai.maxNodes&&this._numNodes>=this.options.ai.maxNodes||(!this.options.ai.noStatOnForcedMove||this.options.ai.noStatOnForcedMove&&o.moves.length>1)&&this._ai_nodeRecurseTree(t,e+1,o.nodes[n]));if(s){for(n=o.moves.length-1;n>=0;n--)0===o.moves[n]&&o.moves.splice(n,1);for(n=o.nodes.length-1;n>=0;n--)null===o.nodes[n]&&o.nodes.splice(n,1);if(o.moves.length!=o.nodes.length)throw"Internal error - Report any error (#005)"}}},AntiCrux.prototype._ai_nodeValuate=function(t){var e,o,n,i;for(void 0===t&&(t=this._root_node),n=0,i=0,e=0;e<64;e++)switch(o=this.options.variant.activePawns&&t.piece[e]==this.constants.piece.pawn&&(t.owner[e]==this.constants.owner.black&&1!=Math.floor(e/8)||t.owner[e]==this.constants.owner.white&&6!=Math.floor(e/8))?this.options.ai.valuation[-t.piece[e]]:this.options.ai.valuation[t.piece[e]],t.owner[e]){case this.constants.owner.black:n+=o;break;case this.constants.owner.white:i+=o}0===n?t.valuation=this.constants.score.infinite:0===i?t.valuation=-this.constants.score.infinite:t.valuation=this.constants.owner.black*n+this.constants.owner.white*i,this._has(t,"moves",!1)&&0===t.moves.length&&(t.valuation=t.player*-this.constants.score.infinite)},AntiCrux.prototype._ai_getMaxValuation=function(t){var e,o,n,i;for(void 0===t&&(t=this._root_node),n=0,i=0,e=0;e<64;e++)switch(o=this.options.ai.valuation[t.piece[e]],t.owner[e]){case this.constants.owner.black:i+=o;break;case this.constants.owner.white:n+=o}return i>n?i:n},AntiCrux.prototype._ai_nodeSolve=function(t,e){var o,n,i,s,r,a,h;if(void 0===e&&(e=this._root_node),!this._has(e,"nodes",!0))return e.valuationSolver=e.valuation,e._forced=!0,e._sequence=e.valuationSolver==t*-this.constants.score.infinite?1:0,void(this.options.ai.opportunistic&&1==e._sequence&&(e._win=!0));for(n=!0,i=!1,o=0;o<e.nodes.length;o++)null!==e.nodes[o]&&(this._ai_nodeSolve(t,e.nodes[o]),e.nodes[o]._forced?i=!0:n=!1,this._has(e.nodes[o],"_win",!1)&&(e._win=!0));if(e.player==t?e._forced=i:e._forced=n,e.player==t&&i){for(r=t*this.constants.score.infinite,o=0;o<e.nodes.length;o++)null!==e.nodes[o]&&(e.nodes[o]._forced?(t==this.constants.owner.white&&e.nodes[o].valuationSolver<r||t==this.constants.owner.black&&e.nodes[o].valuationSolver>r)&&(r=e.nodes[o].valuationSolver):e.nodes[o]=null);for(o=0;o<e.nodes.length;o++)null!==e.nodes[o]&&e.nodes[o].valuationSolver!=r&&(e.nodes[o]=null)}if(s=e.player==t||!this.options.ai.pessimisticScenario){for(e.valuationSolver=0,h=0,o=0;o<e.nodes.length;o++)if(null!==e.nodes[o])if(Math.abs(e.nodes[o].valuationSolver)!=this.constants.score.infinite)e.valuationSolver+=e.nodes[o].valuationSolver,h++;else if(e.nodes[o].valuationSolver==t*this.constants.score.infinite){h=0;break}0!==h?e.valuationSolver=Math.floor(e.valuationSolver/h+.5):s=!1}if(!s){for(a=t*-this.constants.score.infinite,o=0;o<e.nodes.length;o++)null!==e.nodes[o]&&(t==this.constants.owner.white&&e.nodes[o].valuationSolver>a||t==this.constants.owner.black&&e.nodes[o].valuationSolver<a)&&(a=e.nodes[o].valuationSolver);e.valuationSolver=a}if(this.options.ai.acceleratedEndGame){for(a=this.constants.score.infinite,o=0;o<e.nodes.length;o++)null!==e.nodes[o]&&e.nodes[o]._sequence>0&&e.nodes[o]._sequence<a&&(a=e.nodes[o]._sequence);e._sequence=e._forced&&e.valuationSolver==t*-this.constants.score.infinite?a+1:0}else e._sequence=0},AntiCrux.prototype._ai_nodePick=function(t,e){var o,n,i,s,r,a,h;if(void 0===e&&(e=this._root_node),this.options.ai.acceleratedEndGame&&e._forced&&e.valuationSolver==e.player*-this.constants.score.infinite){for(n=this.constants.score.infinite,o=0;o<e.nodes.length;o++)null!==e.nodes[o]&&e.nodes[o]._forced&&e.nodes[o]._sequence>0&&e.nodes[o]._sequence<n&&(n=e.nodes[o]._sequence);if(n==this.constants.score.infinite)throw"Internal error - Report any error (#006)";for(o=0;o<e.nodes.length;o++)null!==e.nodes[o]&&e.nodes[o]._sequence!=n&&(e.nodes[o]=null)}if(this.options.ai.bestStaticScore&&e.nodes.length>1){for(n=t*this.constants.score.infinite,o=0;o<e.nodes.length;o++)null!==e.nodes[o]&&(t==this.constants.owner.white&&e.nodes[o].valuationSolver<n||t==this.constants.owner.black&&e.nodes[o].valuationSolver>n)&&(n=e.nodes[o].valuationSolver);for(o=0;o<e.nodes.length;o++)null!==e.nodes[o]&&e.nodes[o].valuationSolver!=n&&(e.nodes[o]=null)}if(this.options.ai.opportunistic&&e.nodes.length>1)for(i=!1,o=0;o<e.nodes.length;o++)null!==e.nodes[o]&&(i||!this._has(e.nodes[o],"_win",!1)?i&&!this._has(e.nodes[o],"_win",!1)&&(e.nodes[o]=null):(o=-1,i=!0));for(h=[],n=t*this.constants.score.infinite,o=0;o<e.nodes.length;o++)null!==e.nodes[o]&&(s=Math.floor(e.nodes[o].valuationSolver+.5),r=t==this.constants.owner.white&&s<n||t==this.constants.owner.black&&s>n,a=t==this.constants.owner.white&&s==n||t==this.constants.owner.black&&s==n,r&&(h=[],n=s),(a||r)&&h.push(e.moves[o]));switch(h.length){case 0:throw"Internal error - Report any error (#002)";case 1:return h[0];default:return h[Math.floor(Math.random()*(h.length-1)+.5)]}},AntiCrux.prototype._ai_formatScore=function(t,e){return e&&t<-100||t==-this.constants.score.infinite?'<img src="images/mate_'+this.constants.owner.white+'.png" title="White wins" alt="-&#8734;" />':e&&t>100||t==this.constants.score.infinite?'<img src="images/mate_'+this.constants.owner.black+'.png" title="Black wins" alt="+&#8734;" />':t.toFixed(0)+(e?"%":"")},AntiCrux.prototype._ai_nodeTreeHtml=function(t,e,o){var n,i,s,r;if(void 0===o&&(o=this._root_node),this._has(o,"nodes",!1))for(n=0;n<o.nodes.length;n++)if(null!==o.nodes[n]){if(s=e,r=this.options.board.fullDecisionTree||0===t||!this._has(o.nodes[n],"nodes",!0)||t>=3,r&&(this._buffer+='<tr data-depth="'+t+'">',o.nodes[n].hasOwnProperty("valuation")?(this._buffer+="<td>"+this._ai_formatScore(o.nodes[n].valuation,!1)+"</td>",o.nodes[n].hasOwnProperty("valuationSolver")?this._buffer+="<td>"+this._ai_formatScore(o.nodes[n].valuationSolver,!1)+"</td>":this._buffer+="<td>&nbsp;</td>"):this._buffer+="<td>&nbsp;</td><td>&nbsp</td>"),s+="<td>"+this.moveToString(o.moves[n],o)+"</td>",r){for(this._buffer+=s,i=t;i<4;i++)this._buffer+="<td>&nbsp;</td>";this._buffer+="</tr>"}o.nodes[n].hasOwnProperty("nodes")&&t<4&&this._ai_nodeTreeHtml(t+1,s,o.nodes[n])}},AntiCrux.prototype._ai_nodeFreeMemory=function(t){var e;if(void 0===t&&(t=this._root_node),t.hasOwnProperty("nodes")&&null!==t.nodes){for(e=0;e<t.nodes.length;e++)null!==t.nodes[e]&&this._ai_nodeFreeMemory(t.nodes[e]);t.nodes=null,t.moves=null}},"undefined"!=typeof module&&module.exports&&(module.exports=AntiCrux);